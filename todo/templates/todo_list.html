<!-- add_contact.html -->
{% extends 'base.html' %}
{% load static %}
{% block title %} Todo List {{ block.super }}{% endblock %}
{% block content %}
{% load custom_tags %}
{% include 'components/alert.html' %}
<style>
ul li input[type=text] {
display: inline-block;
}</style>
<div class="container-fluid py-4">
  <div class="row mt-4">
    <div class="col-lg-12 col-12">
      <div class="card">
        <div class="card-header pb-0">
          <div class="d-lg-flex">
            <div>
              <h4 class="font-weight-bolder">ToDo List</h4>
            </div>
            <div class="ms-auto my-auto mt-lg-0 mt-4">
              <div class="ms-auto my-auto">
                {% if request.user|has_add_permission:"todo" %}
                  <a href="{% url 'todo_add' %}" class="btn bg-gradient-primary btn-sm mb-0"  style="float: right;">+&nbsp; Add ToDo</a>
                {% endif %}
              </div>
            </div>
          </div>
          {% include 'filter.html' %}
        </div>
        <div class="card-body px-0 pb-0">
          <div class="table-responsive">
             <table class="table table-flush text-dark" id="todo-list">
               <thead class="thead-light">
                 <tr>
                   <th>Title</th>
                   <th>Module</th>
                   <th>Assgined To</th>
                   <th>Status</th>
                   <th>Prioritye</th>
                   <th>Date</th>
                   <th class="custom-last-column">Actions</th>
                 </tr>
               </thead>
               <tbody class="ml-4"> 
                {% for todo_data in todo_list %}
                  <tr class="text-sm">
                    <td>{{ todo_data.title|default:''|truncatechars:20}}</td>
                    <td>{{ todo_data.module.name|title }}</td>
                    <td>{{ todo_data.assigned_to}}</td>
                    <td>{{ todo_data.status|title }}</td>
                    <td>{{ todo_data.priority|title }}</td>
                    <td>{{ todo_data.start_date|date:"M d, Y" }} - {{ todo_data.end_date|date:"M d, Y" }}</td>
                    <td>
                      <div class="dropstart ms-auto pe-0">
                        <a href="javascript:;" class="cursor-pointer" id="dropdownTable2" data-bs-toggle="dropdown" aria-expanded="false">
                          <i class="fa fa-ellipsis-h text-secondary" aria-hidden="true"></i>
                        </a>
                        <ul class="dropdown-menu px-2 py-3 ms-sm-n4 ms-n5" aria-labelledby="dropdownTable2" style="">
                          {% if todo_data.status != 'completed' and request.user|has_update_permission:"todo" == "all" %}
                          <li><a class="dropdown-item border-radius-md" href="{% url 'todo_edit' todo_data.id %}">Edit</a></li>
                        
                          {% elif todo_data.status != 'completed' and request.user == todo_data.user_id and request.user|has_update_permission:"todo" %}
                            <li><a class="dropdown-item border-radius-md" href="{% url 'todo_edit' todo_data.id %}">Edit</a></li>
                            {% endif %}
                            
                            {% if request.user|has_delete_permission:"todo" == "all" or request.user == todo_data.user_id and request.user|has_delete_permission:"todo" %}
                                <li><a class="dropdown-item border-radius-md" href="#" onclick="CustomconfirmDelete({{ todo_data.id }}, 'Are you sure you want to delete this todo?', 'The todo has been deleted successfully.','{% url 'todo_delete' todo_data.id %}')">Delete</a></li>
                            {% endif %}
                            
                            {% if request.user|has_view_permission:"todo" == "all" or request.user|has_view_permission:"todo" %}
                                <li><a class="dropdown-item border-radius-md" href="{% url 'todo_view' todo_data.id %}">View</a></li>
                            {% endif %}
                          </ul>
                        </div>
                      </td>
                  </tr>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
  </div>
{% endblock %}
{% block extra_js %}
<script src="{% static 'assets/js/plugins/sweetalert.min.js' %}"></script>
<script src="{% static 'assets/js/custom_delete.js' %}"></script>
<script src="{% static 'assets/js/plugins/flatpickr.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/datatables.js' %}"></script>
<script>

  if (document.getElementById('todo-list')) {
    const dataTableSearch = new simpleDatatables.DataTable("#todo-list", {
      searchable: true,
      fixedHeight: false,
      perPage: 25
    });

  };
// JavaScript code to apply the filter on each field
function applyFilter(filterName, filterValue) {
  // Handle date range filter
  if (filterName === 'dateRange') {
    const startDate = filterValue[0];
    const endDate = filterValue[1];
    filterValue = `${startDate}_${endDate}`; // Use a custom delimiter to separate start and end dates
  }

  const currentUrl = new URL(window.location.href);
  currentUrl.searchParams.set(filterName, filterValue);
  window.location.href = currentUrl.toString();
}

// JavaScript code to clear single filter on onclick event
function clearFilter(filterName) {
  const currentUrl = new URL(window.location.href);
  currentUrl.searchParams.delete(filterName);
  window.location.href = currentUrl.toString();
}
  // JavaScript code to clear all the filters
function clearAllFilters() {
  const currentUrl = new URL(window.location.href);
  const queryParams = new URLSearchParams(currentUrl.search);
  const filterNames = ['status', 'priority', 'module', 'assigned_to', 'dateRange']; // Add dateRange to the filterNames array

  filterNames.forEach(filterName => {
    queryParams.delete(filterName);
    document.getElementById(`${filterName}Dropdown`).textContent = filterName;
    localStorage.removeItem(filterName); // Remove filter value from localStorage
  });

  window.history.replaceState({}, document.title, `${currentUrl.pathname}?${queryParams.toString()}`);
  window.location.reload(); // Reload the page after clearing all filters
}
// Check URL parameters on page load and update search and filter selections
window.addEventListener('DOMContentLoaded', function() {
  const filterNames = ['status', 'priority', 'module', 'assigned_to', 'dateRange'];
  filterNames.forEach(filterName => {
    const filterValue = new URLSearchParams(window.location.search).get(filterName);
    if (filterValue) {
      document.getElementById(`${filterName}Dropdown`).textContent = filterValue.replace('_', ' to ');
    }
  });

  
});

// Initialize Flatpickr with range mode
if (document.querySelector('.datepicker')) {
  const dateRangeParam = new URLSearchParams(window.location.search).get('dateRange');
  let defaultDates = [];

  if (dateRangeParam) {
    const [startDate, endDate] = dateRangeParam.split('_');
    defaultDates = [new Date(startDate), new Date(endDate)];
  }

  flatpickr('.datepicker', {
    mode: "range", // Enable the range mode to select a date range
    dateFormat: "Y-m-d", // Set your desired date format
    defaultDate: defaultDates, // Pre-fill selected date range
    onClose: function(selectedDates, dateStr, instance) {
      if (selectedDates.length === 2) {
        // When the user selects a date range, apply the filter
        const startDate = selectedDates[0];
        startDate.setHours(0, 0, 0, 0); // Set time to start of the day
        const endDate = selectedDates[1];
        endDate.setHours(23, 59, 59, 999); // Set time to end of the day

        // Manually format the ISO strings without time zone offset
        const formattedStartDate = `${startDate.getFullYear()}-${(startDate.getMonth() + 1).toString().padStart(2, '0')}-${startDate.getDate().toString().padStart(2, '0')}`;
        const formattedEndDate = `${endDate.getFullYear()}-${(endDate.getMonth() + 1).toString().padStart(2, '0')}-${endDate.getDate().toString().padStart(2, '0')}`;

        applyFilter('dateRange', [formattedStartDate, formattedEndDate]);
      }
    }
  });
}





</script>

{% endblock %}     
  
