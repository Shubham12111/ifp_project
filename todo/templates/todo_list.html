<!-- add_contact.html -->
{% extends 'base.html' %}
{% load static %}
{% block title %} Todo List {{ block.super }}{% endblock %}
{% block content %}
{% load custom_tags %}
{% include 'components/alert.html' %}
<style>
ul li input[type=text] {
display: inline-block;
}</style>
<div class="container-fluid py-4">
  <div class="row mt-4">
    <div class="col-lg-8 col-8 mb-3">
        <!-- Add your content here -->
    </div>
    <div class="col-lg-4 col-4 mb-3 text-right">
      {% if request.user|has_add_permission:"todo" %}
        <a href="{% url 'todo_add' %}" class="btn bg-gradient-primary btn-sm mb-0"  style="float: right;">+&nbsp; Add ToDo</a>
      {% endif %}
     
    </div>
        <div class="col-lg-12 col-12">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-lg-flex">
                <div>
                  <h4 class="font-weight-bolder">ToDo List</h4>
                 
                </div>
                <div class="ms-auto my-auto mt-lg-0 mt-4">
                  <div class="ms-auto my-auto">
                    {% include 'filter.html' %}
                  </div>
                </div>
              </div>
            </div>
            
              {% if todo_list %}
            <div class="card-body p-3 pt-0 mt-4">
              <ul class="list-group list-group-flush" data-toggle="checklist">
                {% for todo_data in todo_list %}
                  <li class="list-group-item border-0 flex-column align-items-start ps-0 py-0 mb-3">
                    <div class="checklist-item {% if todo_data.status == 'in-progress' %}checklist-item-warning{% elif todo_data.status == 'completed' %}checklist-item-success{% else %}checklist-item-primary{% endif %} ps-2 ms-3">

                        <div class="d-flex align-items-center  mt-3 ps-1 row">
                          <div class="col-lg-4 col-sm-12 col-xs-12">
                            <h6 class="mb-0 text-dark font-weight-bold text-sm">{{ todo_data.title }}</h6>
                              <p class="text-xs mb-1 text-secondary font-weight-bold">{{ todo_data.description|safe|truncatechars:200 }}</p>   
  
                              <span class="text-xs text-secondary">{{ todo_data.start_date|date:"M d, Y" }} - {{ todo_data.end_date|date:"M d, Y" }}</span>
                            </p> 
                            </div>
                            <div class="col-lg-2 col-sm-12 col-xs-12">
                              <p class="text-md mb-1 text-secondary font-weight-bolder">Module</p>
                              <span class="text-md font-weight-bold">{{ todo_data.module.name|title }}</span>
                            </div>
                            <div class="col-lg-2 col-sm-12 col-xs-12">
                                <p class="text-md mb-1 text-secondary font-weight-bolder">Assgined To</p>
                                <span class="text-md font-weight-bold">{{ todo_data.assigned_to}}</span>
                              </div>
                              <div class="col-lg-2 col-sm-12 col-xs-12">
                              <p class="text-md mb-1 text-secondary font-weight-bolder">Status</p>
                              <span class="text-md font-weight-bold {% if todo_data.status == 'in-progress' %}text-warning{% elif todo_data.status == 'completed' %}text-success{% else %}text-primary{% endif %}">
                                {{ todo_data.status|title }}
                              </span>
                            </div>
                            <div class="col-lg-1 col-sm-12 col-xs-12">
                              <p class="text-md mb-1 text-secondary font-weight-bolder">Priority</p>
                              <span class="text-md font-weight-bold {% if todo_data.priority == 'high' %}text-danger{% elif todo_data.priority == 'medium' %}text-warning{% else %}text-primary{% endif %}">
                                {{ todo_data.priority|title }}
                              </span>
                            </div>
                            <div class="col-lg-1 col-sm-12 col-xs-12 text-end">
                              <div class="dropstart ms-auto pe-0">
                                <a href="javascript:;" class="cursor-pointer" id="dropdownTable2" data-bs-toggle="dropdown" aria-expanded="false">
                                  <i class="fa fa-ellipsis-h text-secondary" aria-hidden="true"></i>
                                </a>
                                <ul class="dropdown-menu px-2 py-3 ms-sm-n4 ms-n5" aria-labelledby="dropdownTable2" style="">
                                  {% if todo_data.status != 'completed' and request.user|has_update_permission:"todo" == "all" %}
                                  <li><a class="dropdown-item border-radius-md" href="{% url 'todo_edit' todo_data.id %}">Edit</a></li>
                                 
                                  {% elif todo_data.status != 'completed' and request.user == todo_data.user_id and request.user|has_update_permission:"todo" %}



                                  <li><a class="dropdown-item border-radius-md" href="{% url 'todo_edit' todo_data.id %}">Edit</a></li>
                                    {% endif %}
                                    
                                    {% if request.user|has_delete_permission:"todo" == "all" or request.user == todo_data.user_id and request.user|has_delete_permission:"todo" %}
                                        <li><a class="dropdown-item border-radius-md" href="#" onclick="CustomconfirmDelete({{ todo_data.id }}, 'Are you sure you want to delete this todo?', 'The todo has been deleted successfully.','{% url 'todo_delete' todo_data.id %}')">Delete</a></li>
                                    {% endif %}
                                    
                                    {% if request.user|has_view_permission:"todo" == "all" or request.user|has_view_permission:"todo" %}
                                        <li><a class="dropdown-item border-radius-md" href="{% url 'todo_view' todo_data.id %}">View</a></li>
                                    {% endif %}

                                      </ul>
                              </div>
                            </div>
                          </div>
                        </div>
                    <hr class="horizontal dark mt-4 mb-0">
                  </li>
                {% endfor %}
               
              </ul>
            </div>
            {% else %}
            <h4 class="font-weight-bolder text-center  p-3 pt-0 mt-4">No records found</h4>
          {% endif %}
          </div>
        </div>
      </div>
</div>



{% endblock %}
{% block extra_js %}
<script src="{% static 'assets/js/plugins/sweetalert.min.js' %}"></script>
<script src="{% static 'assets/js/custom_delete.js' %}"></script>
<script src="{% static 'assets/js/plugins/flatpickr.min.js' %}"></script>

<script>

// // JavaScript code to handle automatic search
// document.getElementById('searchField').addEventListener('input', function(event) {
//   const searchValue = event.target.value;
//   const currentUrl = new URL(window.location.href);
//   currentUrl.searchParams.set('search', searchValue);
//   window.location.href = currentUrl.toString(); // Redirect to the URL with search query
//   localStorage.setItem('searchValue', searchValue); // Store search value in localStorage
// });


 // JavaScript code to apply the filter on each field
 function applyFilter(filterName, filterValue) {
    // Handle date range filter
    if (filterName === 'dateRange') {
      const startDate = filterValue[0];
      const endDate = filterValue[1];
      filterValue = `${startDate}_${endDate}`; // Use a custom delimiter to separate start and end dates
    }

    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set(filterName, filterValue);
    window.location.href = currentUrl.toString();

    // Update the button text with the selected status value
    document.getElementById(`${filterName}Dropdown`).textContent = `${filterValue.replace('_', ' to ')}`; // Update button text with human-readable format
    localStorage.setItem(filterName, filterValue); // Store filter value in localStorage
  }

// JavaScript code to clear single filter on onclick event
function clearFilter(filterName) {
  const currentUrl = new URL(window.location.href);
  currentUrl.searchParams.delete(filterName);
  window.location.href = currentUrl.toString();

  // Reset the button text for the cleared filter
  document.getElementById(`${filterName}Dropdown`).textContent = filterName;
  localStorage.removeItem(filterName); // Remove filter value from localStorage
}


// Check localStorage on page load and update search and filter selections
window.addEventListener('DOMContentLoaded', function() {
    // const searchValue = localStorage.getItem('searchValue');
    // if (searchValue) {
    //   document.getElementById('searchField').value = searchValue;
    // }

    const filterNames = ['status', 'priority', 'module', 'assigned_to','dateRange'];
    filterNames.forEach(filterName => {
      const filterValue = localStorage.getItem(filterName);
      // console.log(filterValue)
      if (filterValue) {
        document.getElementById(`${filterName}Dropdown`).textContent = filterValue;
      }
    });

    // Update the date range filter on page load
    const dateRangeValue = localStorage.getItem('dateRange');
    
    if (dateRangeValue) {
      const dateRangeInput = document.getElementById('dateRangeInput');
      const [startDate, endDate] = dateRangeValue.split('_');
      
      dateRangeInput.value = `${startDate} to ${endDate}`;
    }
  });

  // JavaScript code to clear all the filters
  function clearAllFilters() {
    const currentUrl = new URL(window.location.href);
    const queryParams = new URLSearchParams(currentUrl.search);
    const filterNames = ['status', 'priority', 'module', 'assigned_to', 'dateRange']; // Add dateRange to the filterNames array

    filterNames.forEach(filterName => {
      queryParams.delete(filterName);
      document.getElementById(`${filterName}Dropdown`).textContent = filterName;
      localStorage.removeItem(filterName); // Remove filter value from localStorage
    });

    window.history.replaceState({}, document.title, `${currentUrl.pathname}?${queryParams.toString()}`);
    window.location.reload(); // Reload the page after clearing all filters
  }


// Initialize Flatpickr with range mode
if (document.querySelector('.datepicker')) {
    const dateRangeValue = localStorage.getItem('dateRange');
    let defaultDates = [];
    if (dateRangeValue) {
      const [startDate, endDate] = dateRangeValue.split('_');
      defaultDates = [new Date(startDate), new Date(endDate)];
    }

    flatpickr('.datepicker', {
      mode: "range", // Enable the range mode to select a date range
      dateFormat: "Y-m-d", // Set your desired date format
      defaultDate: defaultDates, // Pre-fill selected date range
      onClose: function(selectedDates, dateStr, instance) {
        if (selectedDates.length === 2) {
          // When the user selects a date range, apply the filter
          const startDate = selectedDates[0].toISOString().split('T')[0];
          const endDate = selectedDates[1].toISOString().split('T')[0];
          applyFilter('dateRange', [startDate, endDate]);
        }
      }
    });
  }


</script>

{% endblock %}     
  
