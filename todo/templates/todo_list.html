<!-- add_contact.html -->
{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
<link id="pagestyle" href="{% static 'assets/css/daterangepicker.css' %}" rel="stylesheet" />

{% endblock %}
{% block title %} Task List {{ block.super }}{% endblock %}
{% block content %}
{% load custom_tags %}
{% include 'components/alert.html' %}
<style>
ul li input[type=text] {
display: inline-block;
}
</style>
<div class="container-fluid py-4">
  <div class="row mt-4">
    <div class="col-lg-12 col-12">
      <div class="card">
        <div class="card-header pb-0">
          <div class="d-lg-flex">
            <div>
              <h4 class="font-weight-bolder">Task List</h4>
            </div>
            <div class="ms-auto my-auto mt-lg-0 mt-4">
              <div class="ms-auto my-auto">
                {% if request.user|has_add_permission:"todo" %}
                  <a href="{% url 'todo_add' %}" class="btn bg-gradient-primary btn-sm mb-0"  style="float: right;">+&nbsp; New Task</a>
                {% endif %}
              </div>
            </div>
          </div>
          {% include 'filter.html' %}
          <div class="row mt-4">
            <div class="col-md-6"></div>
          <div class="col-3"></div>
          <div class="col-xs-12 col-sm-12 col-lg-3 col-md-3  text-end">
            <div class="search">
              <input type="text" id="searchInput" class="form-control" placeholder="Search...">
            </div>
          </div>
        </div>
        <div class="card-body px-0 pb-0">
          <div class="table-responsive">
             <table class="table table-flush text-dark" id="todo-list">
               <thead class="thead-light">
                 <tr>
                   <th>Title</th>
                   <th>Module</th>
                   <th>Assigned To</th>
                   <th>Status</th>
                   <th>Priority</th>
                   <th>Date</th>

                   {% if request.user|has_update_permission:"todo" or request.user|has_add_permission:"todo" or request.user|has_delete_permission:"todo" or request.user|has_view_permission:"todo" %}
                   <th class="custom-last-column">Actions</th>
                   {% endif %}
                 </tr>
               </thead>
               <tbody class="ml-4"> 
                {% for todo_data in todo_list %}
                  <tr class="text-sm">
                    <td>{{ todo_data.title|default:''|truncatechars:20}}</td>
                    <td>{{ todo_data.module.name|title }}</td>
                    <td>{{ todo_data.assigned_to}}</td>
                    <td>{{ todo_data.status|title }}</td>
                    <td>{{ todo_data.priority|title }}</td>
                    <td>{{ todo_data.start_date|date:"d/m/Y " }} - {{ todo_data.end_date|date:" d/m/Y" }}</td>

                    {% if request.user|has_update_permission:"todo" or request.user|has_add_permission:"todo" or request.user|has_delete_permission:"todo" or request.user|has_view_permission:"todo" %}
                    <td>
                      <div class="dropstart ms-auto pe-0">
                        <a href="javascript:;" class="cursor-pointer" id="dropdownTable2" data-bs-toggle="dropdown" aria-expanded="false">
                          <i class="fa fa-ellipsis-h text-secondary" aria-hidden="true"></i>
                        </a>
                        <ul class="dropdown-menu px-2 py-3 ms-sm-n4 ms-n5" aria-labelledby="dropdownTable2" style="">
                          {% if todo_data.status != 'completed' and request.user|has_update_permission:"todo" == "all" %}
                          <li><a class="dropdown-item border-radius-md" href="{% url 'todo_edit' todo_data.id %}">Edit</a></li>
                        
                          {% elif todo_data.status != 'completed' and request.user == todo_data.user_id and request.user|has_update_permission:"todo" %}
                            <li><a class="dropdown-item border-radius-md" href="{% url 'todo_edit' todo_data.id %}">Edit</a></li>
                            {% endif %}
                            
                            {% if request.user|has_delete_permission:"todo" == "all" or request.user == todo_data.user_id and request.user|has_delete_permission:"todo" %}
                                <li><a class="dropdown-item border-radius-md" href="#" onclick="CustomconfirmDelete({{ todo_data.id }}, 'Are you sure you want to delete this Task?', 'The task has been deleted successfully.','{% url 'todo_delete' todo_data.id %}')">Delete</a></li>
                            {% endif %}
                            
                            {% if request.user|has_view_permission:"todo" == "all" or request.user|has_view_permission:"todo" %}
                                <li><a class="dropdown-item border-radius-md" href="{% url 'todo_view' todo_data.id %}">View</a></li>
                            {% endif %}
                          </ul>
                        </div>
                      </td>

                      {% endif %}
                  </tr>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
  </div>
{% endblock %}
{% block extra_js %}
<script src="{% static 'assets/js/plugins/sweetalert.min.js' %}"></script>
<script src="{% static 'assets/js/custom_delete.js' %}"></script>
<script src="{% static 'assets/js/plugins/flatpickr.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/datatables.js' %}"></script>
<script src="{% static 'assets/js/jquery.min.js' %}"></script>
<script src="{% static 'assets/js/moment.min.js' %}"></script>
<script src="{% static 'assets/js/daterangepicker.js' %}"></script>

<script>
  // Initialize the Date Range Picker
  document.addEventListener('DOMContentLoaded', function() {
      let initialStartDate, initialEndDate; // Variables to store the initial dates
  
      function cb(start, end) {
          const formattedStartDate = start.format('DD/MM/YYYY');
          const formattedEndDate = end.format('DD/MM/YYYY');
          const formattedDateRange = formattedStartDate + ' - ' + formattedEndDate;
  
          $('#reportrange span').html(formattedStartDate + ' - ' + formattedEndDate);
          
          applyFilter('dateRange', formattedDateRange);
      }
  
      // Initialize the Date Range Picker without setting an initial date range
      const datePicker = $('#reportrange').daterangepicker({
          autoUpdateInput: false,
          autoApply: true,
          showCustomRangeLabel: true, // Hide the "Custom Range" label
          format: 'DD/MM/YYYY', // Change the format here
          ranges: {
              'Today': [moment(), moment()],
              'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
              'Last 7 Days': [moment().subtract(6, 'days'), moment()],
              'Last 30 Days': [moment().subtract(29, 'days'), moment()],
              'Last 30 Days': [moment().subtract(29, 'days'), moment()]
          },
      });
  
      if (datePicker.data('daterangepicker').showCustomRangeLabel) {
          datePicker.data('daterangepicker').container.find('.ranges ul').append(
              $('<li><a class="dropdown-item border-radius-md text-danger" href="#" onclick="clearFilter(\'dateRange\')">Remove Filter</a></li>')
          );
      }
  
      datePicker.on('apply.daterangepicker', function(ev, picker) {
          cb(picker.startDate, picker.endDate);
      });
  
      datePicker.on('show.daterangepicker', function(ev, picker) {
          initialStartDate = picker.startDate.clone(); // Store initial start date
          initialEndDate = picker.endDate.clone();     // Store initial end date
      });
  
      function dateclearFilter(filterType) {
          if (filterType === 'dateRange') {
              $('#reportrange').data('daterangepicker').setStartDate(moment());
              $('#reportrange').data('daterangepicker').setEndDate(moment());
              $('#reportrange span').html('');
              clearFilter('dateRange'); // Apply empty filter value
          }
      }
  });
  </script>
  
<script>
  if (document.getElementById('todo-list')) {
    const dataTableSearch = new simpleDatatables.DataTable("#todo-list", {
      searchable: true,
      fixedHeight: false,
      perPage: 25,
      perPageSelect: false,
    });

    const dataTableTop = document.querySelector('.dataTable-top');
    if (dataTableTop) {
      dataTableTop.parentNode.removeChild(dataTableTop);
    }
    const searchInput = document.getElementById('searchInput');
      searchInput.addEventListener('input', function() {
        const searchText = searchInput.value.toLowerCase();
        dataTableSearch.search(searchText).draw();
      });
}
const searchInput = document.getElementById('searchAssigned');
const applySearchButton = document.getElementById('applySearch');
const searchResults = document.getElementById('searchResults');
const assignedToDropdown = document.getElementById('assigned_toDropdown'); // Assigned To dropdown element

let currentSearchResults = []; // Store the current search results
let isDropdownOpen = false; // Variable to track dropdown open state

// Function to update search results
function updateSearchResults(results) {
  currentSearchResults = results; // Store the results
  searchResults.innerHTML = '';

  if (results.length > 0) {
    results.forEach(result => {
      const li = document.createElement('li');
      const link = document.createElement('a');
      link.classList.add('dropdown-item', 'border-radius-md');
      link.href = '#';
      link.textContent = result;
      // Add the click event to apply the filter
      link.onclick = function () {
        applyFilter('assigned_to', result);
      };
      li.appendChild(link);
      searchResults.appendChild(li);
    });
  } else {
    const li = document.createElement('li');
    li.classList.add('dropdown-item', 'text-muted');
    li.textContent = 'No results found.';
    searchResults.appendChild(li);
  }
}

// Function to handle Apply Filter button click
function handleApplyFilter() {
  const searchTerm = searchInput.value;

  // Make a request to your backend API with the searchTerm
  // Example using fetch:
  fetch(`/todo/search?term=${searchTerm}`)
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    // Update the search results
    updateSearchResults(data.data.results);

  })
  .catch(error => console.error(error, "error"));
}

// Function to toggle dropdown visibility
function toggleDropdown() {
  isDropdownOpen = !isDropdownOpen;
}

const inputField = document.getElementById('searchAssigned');

inputField.addEventListener('input', () => {
  handleApplyFilter();
  toggleDropdown();
  event.stopPropagation();
});


// Toggle dropdown visibility when clicking on the assignedToDropdown
assignedToDropdown.addEventListener('click', event => {
  toggleDropdown();
  event.stopPropagation();
});

// Listen for clicks on document to close the dropdown if it's open
document.addEventListener('click', () => {
  if (isDropdownOpen) {
    isDropdownOpen = false;
  }
});


// JavaScript code to apply the filter on each field
function applyFilter(filterName, filterValue) {
  
  // Handle date range filter
  if (filterName === 'dateRange') {
    filterValue = filterValue; // Use a custom delimiter to separate start and end dates
    
    
  }
  const currentUrl = new URL(window.location.href);
  currentUrl.searchParams.set(filterName, filterValue);
  window.location.href = currentUrl.toString();
 
  
}

// JavaScript code to clear single filter on onclick event
function clearFilter(filterName) {
  const currentUrl = new URL(window.location.href);
  currentUrl.searchParams.delete(filterName);
  window.location.href = currentUrl.toString();
}
  // JavaScript code to clear all the filters
function clearAllFilters() {
  const currentUrl = new URL(window.location.href);
  const queryParams = new URLSearchParams(currentUrl.search);
  const filterNames = ['status', 'priority', 'module', 'assigned_to', 'dateRange']; // Add dateRange to the filterNames array

  filterNames.forEach(filterName => {
    queryParams.delete(filterName);
    if (filterName === 'dateRange') {
      document.getElementById('reportrange').value = "";
    }

    else{
      document.getElementById(`${filterName}Dropdown`).textContent = filterName;
    }
   
    
  });

  window.history.replaceState({}, document.title, `${currentUrl.pathname}?${queryParams.toString()}`);
  window.location.reload(); // Reload the page after clearing all filters
}


// Check URL parameters on page load and update search and filter selections
window.addEventListener('DOMContentLoaded', function() {
  const filterNames = ['status', 'priority', 'module', 'assigned_to', 'dateRange'];
  filterNames.forEach(filterName => {
    const filterValue = new URLSearchParams(window.location.search).get(filterName);
    
    if (filterValue) {
      let displayedValue = filterValue; // Default displayed value is the filter value itself

      if (filterName === 'dateRange') {
        const formattedDateRange = filterValue.replace('_', ' to ');
        displayedValue = formattedDateRange;
        
        // Also update the date range input field if needed
        document.getElementById('reportrange').value = formattedDateRange;
      } 
      else if (filterValue.length > 9) 
      {
        // Truncate the filter value if it's longer than 5 characters
        displayedValue = filterValue.substring(0, 9) + '..';
      }

      // Update the dropdown element with the displayed value
      document.getElementById(`${filterName}Dropdown`).textContent = displayedValue;
    }
  });
});




</script>

{% endblock %}     
  
  