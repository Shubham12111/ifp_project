{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
<link id="pagestyle" href="{% static '/assets/css/slider.css' %}" rel="stylesheet" />
{% endblock %}
{% load rest_framework %}
{% block title %}STW Defect {{ block.super }}{% endblock %}
{% block content %}
{% load custom_tags %}
{% include 'components/alert.html' %}
<div class="container-fluid my-3 py-3">
    <div class="col-lg-12 mt-4">
         <!-- Card Basic Info -->
        <div class="card mb-4" id="basic-info">
            <div class="card-header">
                <h5> {% if defect_instance %} Edit {% else %} Add {% endif %}  Defect</h5>
            </div>
            <div class="card-body pt-0">
                <form role="form"  method="POST" autocomplete="off" enctype="multipart/form-data" onsubmit="showLoader()" >
                    <div class='row'>
                        {% csrf_token %}
                        {% render_form serializer %}
                    </div>
                    
                        {% if serializer.data.document_paths and  defect_instance %}
                            {% for document in serializer.data.document_paths %}
                                <div class="col-lg-12">
                                    <div style="position: relative;">
                                    <a href="{{ document.presigned_url }}" download>
                                        <span class="text-sm me-2">{{ document.filename }}</span>
                                    </a>
                                    <a href="#" class="delete-icon" onclick="CustomconfirmDelete('{{stw_instance.id}}{{defect_instance.id}} {{document.id}}','Are you sure you want to delete this STW defect document?','The  STW defect document has been deleted successfully.',
                                            '{% url 'remove_stw_defect_document' defect_instance.id  document.id %}')" class="delete-link ms-2" data-title="{{ stw_instance.title}}">
                                            <i class="fas fa-times-circle text-danger">  </i> 
                                        </a>
                                    </div>
                                </div>
                            {% endfor %}
                    {% endif %} 
                    <button class="btn bg-gradient-dark btn-sm float-end mt-2 mb-0 mx-2">Save</button>
                    <a class="btn bg-gradient-secondary btn-sm float-end mt-2 mb-0" href="{% url 'customer_stw_view' customer_id stw_instance.id %}">Back</a>
        
                    </form>
                    {% include 'components/loader.html' %}
            </div>
        </div>
        

    <!--listing of sor-->

    <div class="container-fluid py-4">
        <div class="row">
          <div class="col-12">
            <div class="card">
              <!-- Card header -->
              <div class="card-header pb-0">
                <div class="d-lg-flex">
                  <div>
                    <h5 class="mb-0">SOR List</h4>
                  </div>
                  <div class="ms-auto my-auto mt-lg-0 mt-4">
                    {% if request.user|has_add_permission:"survey" %}
                      <!-- Show the "Add" button only if the user has the 'can_create_data' permission for 'work planning' module -->
                      <a href="" class="btn bg-gradient-primary btn-sm mb-0"  style="float: right;">+&nbsp; Add SOR</a>
                    {% else %}
                      <!-- The user doesn't have the permission, so don't show the "Add" button -->
                    {% endif %}
                </div>
            </div>
        
                {% include 'components/table_search.html' %}
              </div>
              <div class="card-body px-0 pb-0">
                <div class="table-responsive">
                  <table class="table table-flush text-dark" id="stw-sor-list">
                    <thead class="thead-light">
                      <tr>
                        <th class="col-3">Name</th>
                                    <th class="col-3">Description</th>
                                    <th>Price</th>
                                    <th>SOR Code</th>
                                    <th>Created Date</th>
                                    {% if request.user|has_update_permission:"survey" or request.user|has_add_permission:"survey" or request.user|has_delete_permission:"survey" or request.user|has_view_permission:"survey" %}
                      <th class="custom-last-column">Actions</th>
                      {% endif %}
                                   
                      </tr> 
                    </thead>
                    <tbody class="ml-4">
                        {% comment %} {% for defect in stw_defect %} {% endcomment %}
                        <tr class="text-sm">
                            <td class="align-middle">{{ defect.get_defect_type_display }}</td>
                            <td class="align-middle">{{ defect.action|truncatechars:30 }}</td>
                            <td class="align-middle text-truncate" style="max-width: 150px;">{{ defect.description|safe|truncatechars:50 }}</td>
                            <td class="align-middle text-truncate" style="max-width: 150px;">{{ defect.rectification_description|safe|truncatechars:50 }}</td>
                            <td class="align-middle"></td>
                            {% if request.user|has_update_permission:"survey" or request.user|has_add_permission:"survey" or request.user|has_delete_permission:"survey" or request.user|has_view_permission:"survey" %}
                                <td class="align-middle">
                                    <div class="dropstart ms-auto pe-0">
                                        <a href="javascript:;" class="cursor-pointer" id="dropdownTable2" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fa fa-ellipsis-h text-secondary" aria-hidden="true"></i>
                                        </a>
                                        <ul class="dropdown-menu px-2 py-3 ms-sm-n4 ms-n5" aria-labelledby="dropdownTable2">
                                            {% if request.user.roles.name == "projects_admin_(IT)" %}
                                                {% if request.user|has_update_permission:"survey" %}
                                                    <li>
                                                        <a href="" class="dropdown-item border-radius-md">
                                                            Edit
                                                        </a>
                                                    </li>
                                                {% endif %}
                                                {% if request.user|has_update_permission:"survey" %}
                                                    <li>
                                                        <a href="" class="dropdown-item border-radius-md">
                                                            View
                                                        </a>
                                                    </li>
                                                {% endif %}
                                                {% if request.user|has_delete_permission:"survey" %}
                                                 
                                                    {% comment %} <a href="#" type="button" class="dropdown-item border-radius-md" onclick="CustomconfirmDelete({{ defect.id }}, 'Are you sure you want to delete this STW defect?','The STW defect has been deleted successfully.','{% url 'stw_defect_delete' defect.id %}')">
                                                        Delete
                                                    </a> {% endcomment %}
                                                {% endif %}
                                            {% else %}
                                                {% if request.user|has_view_permission:"survey" %}
                                                    <li>
                                                        <a href="" class="dropdown-item border-radius-md">
                                                            View
                                                        </a>
                                                    </li>
                                                {% endif %}
                                            {% endif %}
                                        </ul>
                                    </div>
                                </td>
                            {% endif %}
                        </tr>
                       {% comment %} {% endfor %}  {% endcomment %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      


    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="{% static 'assets/js/plugins/sweetalert.min.js' %}"></script>
<script src="{% static 'assets/js/custom_delete.js' %}"></script>
<script src="{% static 'assets/js/plugins/datatables.js' %}"></script>
<script src="{% static 'assets/js/plugins/choices.min.js' %}"></script>
<script>
    if (document.getElementById('stw-sor-list')) {
        const dataTableSearch = new simpleDatatables.DataTable("#stw-sor-list", {
          searchable: true,
          fixedHeight: false,
          perPage: 25,
          perPageSelect: false,
        });
      
        const dataTableTop = document.querySelector('.dataTable-top');
        if (dataTableTop) {
          dataTableTop.parentNode.removeChild(dataTableTop);
        }
        const searchInput = document.getElementById('searchInput');
          searchInput.addEventListener('input', function() {
            const searchText = searchInput.value.toLowerCase();
            dataTableSearch.search(searchText).draw();
          });
      }

function removeDefect(button) {
    // Find the parent div of the button
    var defectDiv = button.closest('.column-with-border');

    if (defectDiv) {
      // Extract the defect ID from the data attribute
      var defectId = defectDiv.getAttribute('data-defect-id');

      // Find the tbody element within the defect table
      var tbody = document.querySelector('#table-' + defectId + ' tbody');

      if (tbody) {
        // Find all rows within the tbody element
        var rows = tbody.querySelectorAll('tr');


        // After removing the rows inside tbody, you can remove rows after tbody
        var table = document.querySelector('#table-' + defectId);
        if (table) {
          var rowsAfterTbody = Array.from(table.querySelectorAll('tr')).slice(rows.length); // Get rows after tbody
          rowsAfterTbody.forEach(function (row) {
            var rowId = row.getAttribute('id');
            // Remove the price associated with the row after tbody
            if (rowPrices[defectId] && rowPrices[defectId][rowId]) {
              delete rowPrices[defectId][rowId];
            }
            // Remove the row
            row.remove();
          });
        }
      }
      // After removing the defect, call updateTotalPrice to update the total prices for all defect tables
      updateTotalPrice();

      // Finally, remove the entire defect div, including the table
      defectDiv.remove();
    }
  }

  

</script>
{% endblock %}