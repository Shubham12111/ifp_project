{% load static %}

<div class="row px-3 mt-3 justify-content-start">
    <div class="dropdown d-inline me-2 col-auto px-0 mb-2">
        <a href="javascript:;" class="btn btn-outline-dark dropdown-toggle text-start ps-2 mb-0 "
            data-bs-toggle="dropdown" id="statusDropdown">
            <span class="flex-grow-1 text-start custom-search">Status</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-lg-start px-2 py-3 " aria-labelledby="statusDropdown"
            data-popper-placement="bottom-end">

            {% for status in status_values %}
            <li>
                <a class="dropdown-item border-radius-md text-start " href="#"
                    onclick="applyFilter('status', '{{ status.0 }}')">{{ status.1 }}</a>
            </li>
            {% endfor %}
            <li>
                <hr class="horizontal dark my-2">
            </li>
            <li>
                <a class="dropdown-item border-radius-md text-danger" href="#" onclick="clearFilter('status')">Remove
                    Filter</a>
            </li>

        </ul>
    </div>
    <!-- Surveyor list filter-->
    <div class="dropdown d-inline me-2 col-auto px-0 mb-2">
        <a href="javascript:;" class="btn btn-outline-dark dropdown-toggle text-start ps-2 mb-0 "
            data-bs-toggle="dropdown" id="surveyorDropdown">
            Surveyor
        </a>
        <ul class="dropdown-menu dropdown-menu-lg-start px-2 py-3" aria-labelledby="surveyorDropdown"
            data-popper-placement="bottom-end">
            <li>
                <input type="text" id="searchSurveyor" class="form-control" placeholder="Search">
            </li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li id="searchResults"></li>
            <li>
                <hr class="horizontal dark my-2">
            </li>
            <li><a class="dropdown-item border-radius-md text-danger" href="#"
                    onclick="clearFilter('surveyor')">Remove Filter</a>
            </li>
        </ul>
    </div>

    <!--  Date Range list filter-->
    <div class="responsive-date-filter d-inline me-2 col-auto px-0 mb-2" style="width: auto;">
        <input type="text" id="reportrange" class="form-control custom-date-search text-uppercase"
            style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc;"
            placeholder="Select date range">
    </div>

    <div class="d-flex mt-0 col-auto px-0 mb-2" id="table-search-bar-form-row">
        <form class="row justify-content-start justify-content-lg-end w-100" method="get" autocomplete="off" id="searchForm">
            <div class="col-12 text-start text-md-end align-self-center pe-0">
                <div class="p-0 d-flex">
                    <input class="form-control me-2" id="searchbar" name="q" type="text" 
                    placeholder="Search...", 
                    value="{{search_value}}" aria-label="search-input" aira-autocomplete="off">
                    <button type="submit" class="btn bg-gradient-secondary btn-sm mb-0 px-4"><i
                        class="fas fa-search d-lg-none" style="font-size: 0.7rem"></i> <span class="d-none d-lg-block">Search</span></button>
                </div>
            </div>
        </form>
    </div>

    <div class="col-auto px-0 mb-2">
        <!--end of filter-->
        <a href="" class="btn bg-gradient-secondary float-right mb-0 " onclick="clearAllFilters()">
            Clear
        </a>
    </div>
</div>

<script src="{% static 'assets/js/jquery.min.js' %}"></script>
<script src="{% static 'assets/js/moment.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/flatpickr.min.js' %}"></script>
<script src="{% static 'assets/js/daterangepicker.js' %}"></script>
<script>
    // Initialize the Date Range Picker
    document.addEventListener('DOMContentLoaded', function () {
      let initialStartDate, initialEndDate; // Variables to store the initial dates

      function cb(start, end) {
        const formattedStartDate = start.format('DD/MM/YYYY');
        const formattedEndDate = end.format('DD/MM/YYYY');
        const formattedDateRange = formattedStartDate + ' - ' + formattedEndDate;

        $('#reportrange span').html(formattedStartDate + ' - ' + formattedEndDate);

        applyFilter('dateRange', formattedDateRange);
      }

      // Initialize the Date Range Picker without setting an initial date range
      const datePicker = $('#reportrange').daterangepicker({
        autoUpdateInput: false,
        autoApply: true,
        showCustomRangeLabel: true, // Hide the "Custom Range" label
        format: 'DD/MM/YYYY', // Change the format here
        ranges: {
          'Today': [moment(), moment()],
          'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
          'Last 7 Days': [moment().subtract(6, 'days'), moment()],
          'Last 30 Days': [moment().subtract(29, 'days'), moment()],
          'Last 30 Days': [moment().subtract(29, 'days'), moment()]
        },
      });

      if (datePicker.data('daterangepicker').showCustomRangeLabel) {
        datePicker.data('daterangepicker').container.find('.ranges ul').append(
          $('<li><a class="dropdown-item border-radius-md text-danger" href="#" onclick="clearFilter(\'dateRange\')">Remove Filter</a></li>')
        );
      }

      datePicker.on('apply.daterangepicker', function (ev, picker) {
        cb(picker.startDate, picker.endDate);
      });

      datePicker.on('show.daterangepicker', function (ev, picker) {
        initialStartDate = picker.startDate.clone(); // Store initial start date
        initialEndDate = picker.endDate.clone();     // Store initial end date
      });

      function dateclearFilter(filterType) {
        if (filterType === 'dateRange') {
          $('#reportrange').data('daterangepicker').setStartDate(moment());
          $('#reportrange').data('daterangepicker').setEndDate(moment());
          $('#reportrange span').html('');
          clearFilter('dateRange'); // Apply empty filter value
        }
      }
    });
</script>

<script>
    const searchInput = document.getElementById('searchSurveyor');
    const applySearchButton = document.getElementById('applySearch');
    const searchResults = document.getElementById('searchResults');
    const assignedToDropdown = document.getElementById('surveyorDropdown'); // Assigned To dropdown element

    let currentSearchResults = []; // Store the current search results
    let isDropdownOpen = false; // Variable to track dropdown open state

    // Function to update search results
    function updateSearchResults(results) {
      currentSearchResults = results; // Store the results
      searchResults.innerHTML = '';

      if (results.length > 0) {
        results.forEach(result => {
          const li = document.createElement('li');
          const link = document.createElement('a');
          link.classList.add('dropdown-item', 'border-radius-md');
          link.href = '#';
          link.textContent = result;
          // Add the click event to apply the filter
          link.onclick = function () {
            applyFilter('surveyor', result);
          };
          li.appendChild(link);
          searchResults.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.classList.add('dropdown-item', 'text-muted');
        li.textContent = 'No results found.';
        searchResults.appendChild(li);
      }
    }

    // Function to handle Apply Filter button click
    function handleApplyFilter() {
      const searchTerm = searchInput.value;

      // Make a request to your backend API with the searchTerm
      // Example using fetch:
      fetch(`/fra/surveyor/search?term=${searchTerm}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          // Update the search results
          updateSearchResults(data.data.results);

        })
        .catch(error => console.error(error, "error"));
    }

    // Function to toggle dropdown visibility
    function toggleDropdown() {
      isDropdownOpen = !isDropdownOpen;
    }

    const inputField = document.getElementById('searchSurveyor');

    inputField.addEventListener('input', () => {
      handleApplyFilter();
      toggleDropdown();
      event.stopPropagation();
    });
</script>

<script>
    // JavaScript code to apply the filter on each field
    function applyFilter(filterName, filterValue) {

        // Handle date range filter
        if (filterName === 'dateRange') {
          filterValue = filterValue; // Use a custom delimiter to separate start and end dates
  
  
        }
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set(filterName, filterValue);
        window.location.href = currentUrl.toString();
  
  
    }

    // JavaScript code to clear single filter on onclick event
    function clearFilter(filterName) {
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.delete(filterName);
        window.location.href = currentUrl.toString();
      }
    // JavaScript code to clear all the filters
    function clearAllFilters() {
        const currentUrl = new URL(window.location.href);
        const queryParams = new URLSearchParams(currentUrl.search);
        const filterNames = ['status', 'surveyor', 'dateRange', 'q']; // Add dateRange to the filterNames array
  
        filterNames.forEach(filterName => {
          queryParams.delete(filterName);
        });
        window.history.replaceState({}, document.title, `${currentUrl.pathname}?${queryParams.toString()}`);
        window.location.reload(); // Reload the page after clearing all filters
    }


    // Check URL parameters on page load and update search and filter selections
    window.addEventListener('DOMContentLoaded', function () {
        const filterNames = ['status', 'surveyor', 'dateRange', 'q'];
        filterNames.forEach(filterName => {
          const filterValue = new URLSearchParams(window.location.search).get(filterName);
  
          if (filterValue) {
            let displayedValue = filterValue; // Default displayed value is the filter value itself
  
            if (filterName === 'dateRange') {
              const formattedDateRange = filterValue.replace('_', ' to ');
              displayedValue = formattedDateRange;
  
              // Also update the date range input field if needed
              document.getElementById('reportrange').value = formattedDateRange;
            }
            else if (filterValue.length > 9) {
              // Truncate the filter value if it's longer than 5 characters
              displayedValue = filterValue.substring(0, 9) + '..';
            }
  
            // Update the dropdown element with the displayed value
            document.getElementById(`${filterName}Dropdown`).textContent = displayedValue;
          }
        });
      });
</script>