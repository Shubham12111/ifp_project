{% extends 'base.html' %}
{% load static %}
{% block extra_css %}
<style>
    /* Add borders to the table */
    .custom-table th,
    .custom-table td {
      border: 1px solid #dee2e6;
      padding: 8px;
    }
    .column-with-border {
    border: 1px solid #ccc; /* Add your desired border style here */
    padding: 10px; /* Optional: Add padding to the columns for spacing */
    margin-bottom: 10px; /* Optional: Add margin to separate the columns */
  }
  .read-more {
        cursor: pointer; /* Add a pointer cursor when hovering */
    }
</style>
{% endblock %}
{% load rest_framework %}
{% block title %}FRA Reports {{ block.super }}{% endblock %}
{% block content %}
{% load custom_tags %}
{% include 'components/alert.html' %}
<div class="container-fluid mt-3">
  <div class="row align-items-center mb-2">
    <div class="col-lg-6 col-sm-12">
      <h4>Add  Quotation</h4>
    </div>
    <div class="col-lg-6 col-sm-12">
      {% if quotation_data %}
      <a class="btn bg-gradient-secondary btn-sm float-end mt-2 mb-0" href="{% url 'view_customer_quotation_list'  customer_id %}">Back</a>
      {% else %}
        <a class="btn bg-gradient-secondary btn-sm float-end mt-2 mb-0" href="{% url 'view_customer_fra_list_report'  customer_id %}">Back</a>
        {% endif %}
    </div>
</div>
  <div class="row ">
    <div class="col-lg-7 col-sm-12">
      <!-- Works Description and Defects Section -->
      <div class="card">
        <div class="card-header pb-0 mt-0">
            <h5 class="card-title">FRA Details</h5>
        </div>
        <div class="card-body mt-0 text-sm">
          <b>Action</b>
          <p class="text-sm mt-2" style="text-align: justify;">
            <span id="actionText">{{ requirement_instance.action|truncatechars:300 }}</span>
            <span id="actionMore" style="display: none;">{{ requirement_instance.action }}</span>
            <span class="read-more text-primary" id="actionToggle" onclick="toggleReadMore('actionText', 'actionMore', 'actionToggle')">
              Read More
            </span>
          </p>

          <b>Description</b>
          <p class="text-sm mt-2" style="text-align: justify;">
            <span id="descriptionText">{{ requirement_instance.description|truncatechars:300 }}</span>
            <span id="descriptionMore" style="display: none;">{{ requirement_instance.description }}</span>
            <span class="read-more text-primary" id="descriptionToggle" onclick="toggleReadMore('descriptionText', 'descriptionMore', 'descriptionToggle')">
               Read More
            </span>
          </p>
        </div>
      </div>
  </div>
    <div class="col-lg-5 col-sm-12">
        <div class="card">
          <div class="card-header pb-0">
                <h5>Client Details</h5>
            </div>
            <div class="card-body p-3">
              <table class="table align-items-center mb-0">
                  <tbody>
                        <tr class="text-sm">
                            <td><strong>Client</strong></td>
                            <td class="text-warp ">{{ customer_data.first_name|title }} {{ customer_data.last_name|title }}</td>
                        </tr>
                        <tr class="text-sm">
                          <td><strong>Client Email</strong></td>
                          <td class="text-warp ">{{ customer_data.email }}</td>
                      </tr>
                        <tr class="text-sm">
                          <td><strong>Client Address</strong></td>
                          <td>
                            {{ customer_address.address }}
                            {% if customer_address.town %}
                              {{ customer_address.town.name }},
                            {% endif %}
                            {% if customer_address.county %}
                              {{ customer_address.county.name }},
                            {% endif %}
                            {% if customer_address.country %}
                              {{ customer_address.country.name }}
                            {% endif %}
                            {% if customer_address.country.post_code %}
                              , {{ customer_address.country.post_code }}
                            {% endif %}
                          </td>
                        </tr>
                        <tr class="text-sm">
                          <td><strong>Job Address</strong></td>
                          <td  class="text-warp">{{ requirement_instance.site_address }}</td>
                        </tr>
                        <tr class="text-sm">
                          <td><strong>UPRN</strong></td>
                          <td  class="text-warp">{{ requirement_instance.UPRN|default:''|title }}</td>
                        </tr>
                        <tr class="text-sm">
                          <td><strong>RBNO</strong></td>
                          <td  class="text-warp">{{ requirement_instance.RBNO|default:''|title }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
      </div>
      
    </div>
    <div class="row ">
      <div class="col-lg-12 col-sm-12">
          <div class="card mt-4 mx-0">
            <div class="card-header pb-0">
              <h5>Defects</h5>
            </div>
            <div class="card-body mt-0 ">
           {% for defect in requiremnt_defect_instances %}
           <div class="row column-with-border ">
           <h6>Defect {{ forloop.counter }} - <span class="text-sm">({{defect.get_defect_type_display}})</span></h6>
          
             <div class="col-lg-4 col-sm-12 text-sm ">
              <b >Action</b>
               <p class="text-sm mt-2" style="text-align: justify;">
                 <span id="defectActionText{{ forloop.counter }}">{{ defect.action|truncatechars:150 }}</span>
                 <span id="defectActionMore{{ forloop.counter }}" style="display: none;">{{ defect.action }}</span>
                 <span class="read-more text-primary" id="defectActionToggle{{ forloop.counter }}" onclick="toggleReadMore('defectActionText{{ forloop.counter }}', 'defectActionMore{{ forloop.counter }}','defectActionToggle{{ forloop.counter }}')"> Read More
                 </span>
               </p>
             </div>
             <div class="col-lg-4 col-sm-12 text-sm">
               <b>Description</b>
               <p class="text-sm mt-2" style="text-align: justify;">
                 <span id="defectDescriptionText{{ forloop.counter }}">{{ defect.description|truncatechars:150 }}</span>
                 <span id="defectDescriptionMore{{ forloop.counter }}" style="display: none;">{{ defect.description }}</span>
                 <span class="read-more text-primary" id="defectDescriptionToggle{{ forloop.counter }}" onclick="toggleReadMore('defectDescriptionText{{ forloop.counter }}', 'defectDescriptionMore{{ forloop.counter }}','defectDescriptionToggle{{ forloop.counter }}')"> Read More
                 </span>
               </p>
             </div>
             <div class="col-lg-4 col-sm-12 text-sm">
               <b>Rectification Description</b>
               <p class="text-sm mt-2" style="text-align: justify;">
                 <span id="defectRectificationText{{ forloop.counter }}">{{ defect.rectification_description|truncatechars:150 }}</span>
                 <span id="defectRectificationMore{{ forloop.counter }}" style="display: none;">{{ defect.rectification_description }}</span>
                 <span class="read-more text-primary" id="defectRectificationToggle{{ forloop.counter }}"  onclick="toggleReadMore('defectRectificationText{{ forloop.counter }}', 'defectRectificationMore{{ forloop.counter }}','defectRectificationToggle{{ forloop.counter }}')">Read More
                 </span>
               </p>
             </div>
          
              <div class="col-lg-12 col-sm-12">
                {% csrf_token %}
                
                  <!-- Empty table element with a unique ID -->
                  <table id="table-{{ defect.id }}" class="custom-table text-sm" style="width:100%">
                    <!-- Table content will be added dynamically here -->
                    <tr id="header-{{ defect.id }}" {% if quotation_data.quotation_json.defectSorValues %}{% else %} style="display: none;"{% endif %}>
                      <th class="col-4">SOR Code</th>
                      <th>Category</th>
                      <th>Price(Â£)</th>
                      <th class="col-1">Action</th>
                      <!-- Add more headers as needed -->
                    </tr>
                    </table>
                </div>
                <div class="col-lg-12 col-sm-12 mb-0">
                  <button class="btn bg-gradient-primary btn-sm mt-4" data-defect-id="{{ defect.id }}" onclick="addTable(this)">Add SOR</button>
                </div>
                
              </div>
              {% endfor %}
              <div class="row ">
                <div class="col-lg-6 col-sm-6">

                </div>
                <div class="col-lg-6 col-sm-6 mt-4">
                  <h5 class="text-end text-md">
                    
                    <strong>SOR Total : </strong> <span id="total-price"></span>
                    
                  </h5>
                </div>

                <div class="col-lg-12 col-sm-12 mt-4">
                  <button  id="submit-button" class="btn bg-gradient-dark btn-sm float-end mt-2 mb-0 mx-2">Submit</button>
                  <button  id="submit-darft-button"  class="btn bg-gradient-dark btn-sm float-end mt-2 mb-0 mx-2">Save As Draft</button>
                 
                  {% include 'components/loader.html' %}
                </div>
              </div>
                
            </div>
          </div>
          
        </div>
        
      </div>
    </div>


{% endblock %}
{% block extra_js %}
<script src="{% static 'assets/js/plugins/sweetalert.min.js' %}"></script>
<script src="{% static 'assets/js/custom_delete.js' %}"></script>
<script src="{% static 'assets/js/plugins/datatables.js' %}"></script>
<script src="{% static 'assets/js/plugins/choices.min.js' %}"></script>
<script>

const loaderOverlay = document.getElementById("loaderOverlay"); // Loader overlay element

function showLoader() {
    loaderOverlay.classList.remove("d-none"); // Show the loader overlay
}

function hideLoader() {
    loaderOverlay.classList.add("d-none"); // Hide the loader overlay
}


function toggleReadMore(truncateId, fullId, toggleId) {
  const truncateElement = document.getElementById(truncateId);
  const fullElement = document.getElementById(fullId);
  const toggleElement = document.getElementById(toggleId);

  if (truncateElement.style.display === 'none') {
    // Show truncated text and hide full text
    truncateElement.style.display = '';
    fullElement.style.display = 'none';
    toggleElement.textContent = 'Read More';
  } else {
    // Show full text and hide truncated text
    truncateElement.style.display = 'none';
    fullElement.style.display = '';
    toggleElement.textContent = 'Read Less';
  }
}

var totalAllDefects = 0;
var rowPrices = {};
var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

{% if quotation_data %}
// Assuming you have a JSON string in quotation_data.quotation_json
var jsonString = '{{ quotation_data.quotation_json|safe|escapejs }}';
var sanitizedJsonString = jsonString.replace(/'/g, '"').replace(/\\xa0/g, '\\u0020');

var savedData = JSON.parse(sanitizedJsonString);

function populateSavedRows(defectId) {
  
  if (savedData.defectSorValues[defectId]) {

    Object.keys(savedData.defectSorValues[defectId]).forEach(function(inner_key) {
      
      var tableId = "table-" + defectId;
      var headerId = "header-" + defectId;
      
      rowPrices[defectId] = rowPrices[defectId] || {}; // Ensure the defectId key exists

      // Check if the table already exists, and if not, create it
      var existingTable = document.getElementById(tableId);
      
      
      var savedRow = savedData.defectSorValues[defectId][inner_key];
      var sorItem = savedRow['sor_items'];

      var newRow = document.createElement('tr');
      var rowId = inner_key; // Create a unique ID for each row
      newRow.id = rowId;
        // Create and append the first <td> with the dropdown <select> element
      var firstCell = document.createElement('td');
      var select = document.createElement('select');
      select.className = 'form-control';
      select.id = 'choices-sor-' + defectId + '-' + rowId;

      // Assuming sorItem has properties like 'id', 'user_id', 'customer_id', 'category_id', etc.
      var option = document.createElement('option');
      option.value = sorItem.id; // You can use any property you need here
      option.textContent = sorItem.reference_number; // You can use any property you need here

      select.appendChild(option);
      firstCell.appendChild(select);
        newRow.appendChild(firstCell);

        // Create and append the second <td> for category
        var categoryCell = document.createElement('td');
        categoryCell.textContent = sorItem.category_id;
        newRow.appendChild(categoryCell);

        // Create and append the third <td> for price
        var priceCell = document.createElement('td');
        priceCell.textContent = sorItem.price;
        newRow.appendChild(priceCell);

        // Create and append the fourth <td> with the "x" icon to delete the row
        var deleteCell = document.createElement('td');
        var deleteIcon = document.createElement('span');
        deleteIcon.textContent = 'x';
        deleteIcon.style.cursor = 'pointer';
        deleteIcon.classList.add('text-danger', 'text-center');

        deleteIcon.addEventListener('click', function() {
          removeRow(defectId, rowId);
        });

        deleteCell.appendChild(deleteIcon);
        newRow.appendChild(deleteCell);

        // Create and append the hidden input for the SOR ID
        var sorIdInput = document.createElement('input');
        sorIdInput.type = 'hidden';
        sorIdInput.name = 'sor-id'; // You can specify a unique name here if needed
        sorIdInput.id = 'sor-id-' + defectId + '-' + rowId;
        sorIdInput.value = sorItem.id; // Set the value of the SOR ID input
        newRow.appendChild(sorIdInput);
        // Update the row price in the array
        rowPrices[defectId][rowId] = sorItem.price;

        // Calculate and display the total price for the current defect table
        var defectTotal = Object.values(rowPrices[defectId]).reduce(function(sum, rowPrice) {
          return sum + (parseFloat(rowPrice) || 0);
        }, 0);

        // Update the total for the current defect
        updateDefectTotal(defectId, defectTotal);

        // Update the total price for all defect tables
        updateTotalPrice();
        // Append the new row to the table
        existingTable.appendChild(newRow);
      
     
    });
  }
}



// Loop through the defectSorValues object and call the function to populate saved rows for each defectId
Object.keys(savedData.defectSorValues).forEach(function(defectId) {
  populateSavedRows(defectId);
});
{% endif %}




function addTable(button) {
    var defectId = button.getAttribute('data-defect-id');
    var tableId = "table-" + defectId;
    var headerId = "header-" + defectId;
    
    
    // Check if the table already exists, and if not, create it
    var existingTable = document.getElementById(tableId);
    if (!existingTable) {
      var table = document.createElement('table');
      table.id = tableId;
      table.className = 'custom-table mb-4 text-sm';
      table.style.width = '100%';
      
      // Create and add table headers initially hidden
      var tableHeader = document.createElement('tr');
      tableHeader.id = headerId;
      tableHeader.style.display = 'none';
      tableHeader.innerHTML = '<th>SOR Column 1</th><th>SOR Column 2</th>'; // Add more headers as needed
      table.appendChild(tableHeader);
      
      document.querySelector('.col-lg-12.col-sm-12').appendChild(table);
    }

    // Show the headers
    var headerRow = document.getElementById(headerId);
    headerRow.style.display = 'table-row';
    
    const allSors = JSON.parse('{{ all_sors|safe }}');
    // Create a new row for the table
    var newRow = document.createElement('tr');
    var rowId = Date.now(); // Unique row ID
    newRow.id = rowId;

    rowPrices[defectId] = rowPrices[defectId] || {}; // Ensure the defectId key exists


    // Add the first <td> with the dropdown <select> element
    var firstCell = document.createElement('td');
    var select = document.createElement('select');
    select.className = 'form-control';
    select.id = 'choices-sor-' + defectId + '-' + rowId; // Set the ID for the select element to include bot
    var defaultOption = document.createElement('option');
    defaultOption.textContent = ' ';
    select.appendChild(defaultOption);
    allSors.forEach(sor => {
      var option = document.createElement('option');
      option.value = sor.reference_number;
      option.textContent = sor.reference_number;
      select.appendChild(option);
    });
    firstCell.appendChild(select);
    newRow.appendChild(firstCell);


    // Add a hidden input for the SOR ID
    var sorIdInput = document.createElement('input');
    sorIdInput.type = 'hidden';
    sorIdInput.name = 'sor-id'; // You can specify a unique name here if needed 
    sorIdInput.id = 'sor-id-'+defectId + '-' + rowId; // 
    newRow.appendChild(sorIdInput);
   // Add the second <td> for category
    var categoryCell = document.createElement('td');
    newRow.appendChild(categoryCell);

    // Add the third <td> for price
    var priceCell = document.createElement('td');
    newRow.appendChild(priceCell);

    // Add the fourth <td> with the "x" icon to delete the row
      var deleteCell = document.createElement('td');
      var deleteIcon = document.createElement('span');
      deleteIcon.textContent = 'x';
      deleteIcon.style.cursor = 'pointer';
      deleteIcon.classList.add('text-danger', 'text-center'); // Add the classes to the delete icon

      // Modify your existing deleteIcon.addEventListener as follows:
    deleteIcon.addEventListener('click', function() {
      removeRow(defectId, rowId); // Call the removeRow function when "x" is clicked
    });

    deleteCell.appendChild(deleteIcon);
    newRow.appendChild(deleteCell);

      // Append the new row to the table
    existingTable.appendChild(newRow);

    // Initialize Choices.js for the dropdown
    var element = document.getElementById( 'choices-sor-' + defectId + '-' + rowId);
    const vendor_choices = new Choices(element, {
      default: false,
      items: [],
      choices: [],
      renderChoiceLimit: 5,
      searchEnabled: true,
      searchChoices: true,
      searchFloor: 1,
      searchResultLimit: 10,
      resetScrollPosition: true,
      shouldSort: true,
      shouldSortItems: false,
      searchPlaceholderValue: "Search Sor....",
      fuseOptions: {
        includeScore: true,
        includeMatches: true,
        threshold: 0, // Set to 0 for an exact match
        location: 0,
        distance: 100,
        maxPatternLength: 32,
        minMatchCharLength: 1
      }
    });


  // Listen for changes in the dropdown and update other <td> elements
    element.addEventListener('change', function() {
      var selectedValue = element.value; // Get the selected value
      // Find the corresponding SOR object based on the selected value
      var selectedSor = allSors.find(sor => sor.reference_number === selectedValue);
      if (selectedSor) {
        
        // Update category and price <td> elements with data from the selected SOR object
        categoryCell.textContent = selectedSor.category_id__name; // Update category
        priceCell.textContent = selectedSor.price;      // Update price
        sorIdInput.value = selectedSor.id;      // Update price
        // Update the row price in the array
       
        rowPrices[defectId][rowId] = selectedSor.price;
        
      
         // Calculate and display the total price for the current defect table
        var defectTotal = Object.values(rowPrices[defectId]).reduce(function(sum, rowPrice) {
          return sum + (parseFloat(rowPrice) || 0);
        }, 0);

         // Update the total for the current defect
          updateDefectTotal(defectId, defectTotal);

        // Update the total price for all defect tables
        updateTotalPrice();
  }
      
  });
    
  }


var totalPriceInput = document.getElementById('total-price');


// Function to remove a row from a defect table
function removeRow(defectId, rowId) {
  // Check if the defectId exists in rowPrices
  if (rowPrices.hasOwnProperty(defectId)) {
    // Remove the row price from the current defect
    delete rowPrices[defectId][rowId];
    // Calculate and display the total price for the current defect table
    var defectTotal = Object.values(rowPrices[defectId]).reduce(function (sum, rowPrice) {
      return sum + (parseFloat(rowPrice) || 0);
    }, 0);

    // Update the total for the current defect
    updateDefectTotal(defectId, defectTotal);

    // Get the HTML element for the row and remove it
    var rowToRemove = document.getElementById(rowId);
    if (rowToRemove) {
      rowToRemove.parentNode.removeChild(rowToRemove);
    }

    // Update the total price for all defect tables
    updateTotalPrice();
  }
}

// Function to update the total price for the current defect table
function updateDefectTotal(defectId, total) {
  // Update the total price input for the current defect table
  var totalInput = document.getElementById('total-price-' + defectId);
  if (totalInput) {
    totalInput.textContent = total.toFixed(2); // Format the total as needed
  }
}

// Function to update the total price for all defect tables
function updateTotalPrice() {
  // Calculate the total price of all defect tables
  totalAllDefects = Object.keys(rowPrices).reduce(function(sum, defectId) {
    var defectPrices = rowPrices[defectId];
    var defectTotal = Object.values(defectPrices).reduce(function(defectSum, price) {
      return defectSum + (parseFloat(price) || 0);
    }, 0);
    return sum + defectTotal;
  }, 0);

  // Update the total price input for all defect tables
  var totalPriceInput = document.getElementById('total-price');
  if (totalPriceInput)
  {
    totalPriceInput.textContent = totalAllDefects.toFixed(2); // Format the total as needed
  }
}


// Get references to the "Submit" and "Save As Draft" buttons
var submitButton = document.getElementById('submit-button');
var saveDraftButton = document.getElementById('submit-darft-button');

// Add click event listeners to the buttons
submitButton.addEventListener('click', function () {
  showLoader(); 
  sendDataToServer('submitted'); // Set the status to "submitted" when "Submit" is clicked
});

saveDraftButton.addEventListener('click', function () {
  showLoader(); 
  sendDataToServer('draft'); // Set the status to "draft" when "Save As Draft" is clicked
});

// Function to send data to the server
// Function to send data to the server using fetch
function sendDataToServer(status) {
  // Collect the data you want to send to the server, including defect-SOR values
  var dataToSend = {
    // Include your data here
    status: status, // Include the status based on the button clicked
    total_amount : totalPriceInput.textContent,
    defectSorValues: {}, // Initialize an empty object to store defect-SOR values
  };
    // Loop through each defectId in rowPrices and add the corresponding SOR values with IDs to the data
    for (var defectId in rowPrices) {
      if (rowPrices.hasOwnProperty(defectId)) {
        var defectSorData = {}; // Initialize an empty object for defect-SOR data
        for (var rowId in rowPrices[defectId]) {
          if (rowPrices[defectId].hasOwnProperty(rowId)) {
            // Get the price for this row
            var price = rowPrices[defectId][rowId];
            // Fetch the SOR ID from the hidden input field within the row
            var sorIdInput = document.querySelector('#' + 'sor-id-' + defectId + '-' + rowId);
            
            var sorId = sorIdInput.value; // Fetch the SOR ID from the hidden input

            // Add the SOR ID and price to the defect-SOR data
            defectSorData[rowId] = {'sor-id':sorId,'price':price};
            
          }
        }

        // Add the defect-SOR data to the main data object
        dataToSend.defectSorValues[defectId] = defectSorData;
      }
    }

   
    // Check if dataToSend has some values
    if (Object.keys(dataToSend.defectSorValues).length > 0) {
      // There are values to send, proceed with the fetch request
      // Make a fetch request to send the data to the server
      fetch("{% if quotation_data %}{% url 'edit_customer_estimation' customer_id quotation_data.id %}{% else %}{% url 'add_customer_estimation' customer_id report_instance.id %}{% endif %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken, // Include the CSRF token here
        },
        body: JSON.stringify(dataToSend),
      })
        .then(function (response) {
          if (response.ok) {
            // Request was successful, handle the server's response if needed
            
            window.location.href = "{% if quotation_data %}{% url 'view_customer_quotation_list' customer_id %}{% else %}{% url 'view_customer_fra_list_report' customer_id %}{% endif %}";
          } else {
            // Handle errors or failed requests
            console.error('Error sending data to the server');
          }
        })
        .catch(function (error) {
          // Handle network errors or other exceptions
          console.error('Error:', error);
        });
    } else {
      // No values to send
      hideLoader();
      alert("There are no values to send.");
    }
  }



</script>


{% endblock %}