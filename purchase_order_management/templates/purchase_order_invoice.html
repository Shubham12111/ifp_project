<!-- add_customer.html -->
{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}
{% block title %} Purchase Order View{{ block.super }}{% endblock %}
{% block content %}
{% include 'components/alert.html' %}
<style>
    /* Add borders to the table */
    .custom-table th,
    .custom-table td {
      border: 1px solid #dee2e6;
      padding: 8px;
    }
    .btn.btn-outline-dotted {
    border: 1px dotted #000; /* Replace #000 with the desired color for the border */
    background-color: transparent;
    color: #000; /* Replace #000 with the desired text color */
}
.choices__item--disabled{
  display: none !important;
}
</style>
<div class="container-fluid py-4">
    <div class="card">
        <div class="card-body px-3 pb-3 pt-3">
            <div class="row">
                <div class="col-lg-3 col-md-3 col-12">
                    <ul class="list-group">
                        <li class="list-group-item border-0 d-flex p-4 mb-2 bg-gray-100 border-radius-lg">
                            <div class="d-flex flex-column">
                            <h6 class="mb-3 text-sm">Vendor Information </h6>
                            <span class="mb-2 text-xs">Vendor Name: <span class="text-dark font-weight-bold ms-2"> {{purchase_order.vendor_id.first_name}} {{purchase_order.vendor_id.last_name}}</span></span>
                            <span class="mb-2 text-xs">Phone Number: <span class="text-dark font-weight-bold ms-2"> {{purchase_order.vendor_id.phone_number}}</span></span>
                            <span class="mb-2 text-xs">Email Address: <span class="text-dark ms-2 font-weight-bold"> {{purchase_order.vendor_id.email}}</span></span>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="col-lg-3 col-md-3 col-12">
                    <ul class="list-group">
                        <li class="list-group-item border-0 d-flex p-4 mb-2 bg-gray-100 border-radius-lg">
                            <div class="d-flex flex-column">
                            <h6 class="mb-3 text-sm">Inventory Location Information</h6>
                            <span class="mb-2 text-xs">Name: <span class="text-dark font-weight-bold ms-2"> {{purchase_order.inventory_location_id.name}}</span></span>
                            <span class="mb-2 text-xs">Address: <span class="text-dark font-weight-bold ms-2"> {{purchase_order.inventory_location_id.address}}</span></span>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="col-lg-3 col-12 ms-auto">
                   <div class="d-flex justify-content-between">
                        <span class="mb-2 font-weight-bold">PO Number :</span>
                        <span class="text-dark ms-2">{{purchase_order.po_number}}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="mb-2  font-weight-bold" >Date:</span>
                        <span class="text-dark ms-2 ">{{purchase_order.order_date}}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="mb-2  font-weight-bold">Order Date:</span>
                            <span class="text-dark ms-2 ">{{purchase_order.due_date}}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="font-weight-bold">Status:</span>
                            <span class="text-dark ms-2 ">{{purchase_order.get_status_display}}</span>
                        </div>
                        
                </div>
            </div>
            <form method="post" enctype="multipart/form-data" id="invoiceForm">
                {% csrf_token %}
                
                <div class="row mt-5">
                    <div class="col-md-12">
                    <!-- Input fields for invoice details -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="invoiceNumber">Invoice Number:</label>
                                <input type="text" id="invoiceNumber" name="invoice_number" class="form-control" placeholder="Enter Invoice Number" required>
                            </div>
                            <div class="col-md-4">
                                <label for="invoiceDate">Invoice Date:</label>
                                <input type="date" id="invoiceDate" name="invoice_date"  class="form-control invoice_date" required>
                            </div>
                            <div class="col-md-4">
                                <label for="invoicePDF">Invoice PDF:</label>
                                <input type="file"  id="invoicePDF"  class="form-control" accept=".pdf">
                            </div>
                        </div>
                        <table class="table-responsive custom-table mb-3 " style="width:100%">
                                <thead>
                                    <tr class="px-0">
                                        <th class="text-start col-4">Item Name</th>
                                        <th class="text-center col-2">Price</th>
                                        <th class="text-center col-2">Quantity </th>
                                        <th class="text-center col-2">Recived Quantity </th>
                                        <th class="text-center col-3">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    
                                    {% for item in purchase_order_items %}
                                    <tr class="">
                                        <td class="text-sm">{{item.item_name}} </td>
                                        <td class="text-sm text-center">£ {{item.unit_price}} </td>
                                        <td class="text-sm text-center">{{item.quantity}} </td>
                                        <td class="text-sm">
                                            <input type="number" class="form-control quantity-input" value="0" data-max="{{item.quantity}}" data-item-id="{{item.id}}">
                                            <p class="error-message text-sm text-danger" style=" display: none;">Exceeds available quantity</p>
                                        </td>

                                        <td class="text-sm text-center">£ {{item.row_total}} </td>
                                    </tr>
                                    {% endfor %}
                                    
                                </tbody>
                            </table>
                        </div>
                </div>
                    <div class="row mt-4">
                        <div class="col-md-6 ">
                            {% if purchase_order.notes %}
                            <h6 class=" text-sm">Notes </h6>
                            <span class="notes text-sm">{{ purchase_order.notes }}</span>
                            <br>
                            {% endif %}
                            {% if purchase_order.approval_notes %}
                                <h6 class="mt-2  text-sm">Approval Notes </h6>
                                <span class="approval_notes text-sm">{{ purchase_order.approval_notes }}</span>
                            {% endif %}
                        </div>
                        <div class="col-lg-3 col-12 ms-auto">
                            <div class="d-flex justify-content-between">
                                    <span class="mb-2 text-sm">Sub Total</span>
                                    <span class="text-dark font-weight-bold ms-2">£ {{ purchase_order.sub_total }}</span>
                                </div>
                            <div class="d-flex justify-content-between">
                                <span class="mb-2 text-sm">Discount </span>
                                <span class="text-dark ms-2 font-weight-bold">£ {{ purchase_order.discount}}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-sm"> Taxes:</span>
                                <span class="text-dark ms-2 font-weight-bold">£ {{ purchase_order.tax }}</span>
                            </div>
                            <div class="d-flex justify-content-between mt-4">
                                <span class="mb-2 text-lg">Total</span>
                                <span class="text-dark text-lg ms-2 font-weight-bold">£ {{ purchase_order.total_amount }}</span>
                        </div>
                    </div>
                </div>
                <div class="row mt-5 mb-3">
                    <div class="col-6 col-lg-6 m-auto text-end"></div>
                    <div class="col-md-6 m-auto text-center text-md-end">
                        <a class="btn bg-gradient-secondary mb-0 js-btn-prev ms-2 mb-0" href="{% url 'purchase_order_list' %}">Cancel</a>
                        <button class="btn btn-md bg-gradient-primary ms-2 mb-0 js-btn-next" id="submitButton" type="button">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
            
{% endblock %}
{% block extra_js %}
<script src="{% static 'assets/js/plugins/flatpickr.min.js' %}"></script>
<script>
 // Check if the datetimepicker element exists
 if (document.querySelector('.invoice_date')) {
    // Get the default value for the datetime picker
    const defaultDateValue = 'invoice_date';

    // Convert the default value to a Date object (if available)
    const defaultDate = defaultDateValue ? new Date(defaultDateValue) : new Date();

    // Create the flatpickr date-time picker and set the default date to the default value or current date
    flatpickr('.invoice_date', {
      allowInput: false,
      defaultDate: defaultDate
    });
  }


const quantityInputs = document.querySelectorAll('.quantity-input');

quantityInputs.forEach(input => {
    const maxQuantity = parseInt(input.getAttribute('data-max'));
    const errorMessage = input.parentElement.querySelector('.error-message');

    input.addEventListener('input', () => {
        const enteredQuantity = parseInt(input.value);

        if (isNaN(enteredQuantity)) {
            errorMessage.style.display = 'none';
        } else if (enteredQuantity > maxQuantity) {
            errorMessage.style.display = 'block';
        } else {
            errorMessage.style.display = 'none';
        }
    });
});

document.addEventListener('DOMContentLoaded', function() {
    const submitButton = document.getElementById('submitButton');
    
    submitButton.addEventListener('click', function() {
        const formData = new FormData(document.getElementById('invoiceForm'));
        const quantityInputs = document.querySelectorAll('.quantity-input');
        
        const recipeQuantities = [];
        quantityInputs.forEach(input => {
            const purchase_order_item_id = input.getAttribute('data-item-id');
            const received_inventory = input.value;
            recipeQuantities.push({ purchase_order_item_id, received_inventory });
        });
        
        formData.append('purchase_order_items', JSON.stringify(recipeQuantities));
        
        // Send data via Fetch API
        fetch('{% url 'purchase_order_convert_to_invoice' purchase_order.id %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        }).then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Request failed');
            }
        }).then(data => {
            if (data.errors) {
                const existingErrorMessages = document.querySelectorAll('.help-block');
                existingErrorMessages.forEach(errorMessage => errorMessage.remove());
                

                for (const fieldName in data.errors) {
                    const field = document.querySelector(`[name="${fieldName}"]`);
                    
                    if (field) {
                        const tagName = field.nodeName.toLowerCase(); // Get the lowercase tag name
                        if (tagName === 'select') {
                            // For select elements, display error message near the select element
                            const selectContainer = field.closest('.choices'); // Adjust this selector based on your HTML structure
                            console.log(selectContainer)
                            if (selectContainer) {
                                const errorElement = document.createElement('div');
                                errorElement.classList.add('help-block', 'mt-2');
                                errorElement.textContent = data.errors[fieldName].join(', ');
                                selectContainer.appendChild(errorElement);
                            }
                        } else {
                            // For other input elements, display error message under the field
                            const errorElement = document.createElement('div');
                            errorElement.classList.add('help-block', 'mt-2');
                            errorElement.textContent = data.errors[fieldName].join(', ');
                            field.parentElement.appendChild(errorElement);
                        }
                    }
                }
            } else {
                // Handle success
            }
        }).catch(error => {
            // Handle error
        });
    });
});


</script>
{% endblock %}
