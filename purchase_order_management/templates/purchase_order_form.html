<!-- add_customer.html -->
{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}
{% block title %} Purchase Order Add{{ block.super }}{% endblock %}
{% block content %}
<style>
    /* Add borders to the table */
    .custom-table th,
    .custom-table td {
      border: 1px solid #dee2e6;
      padding: 8px;
    }
    .btn.btn-outline-dotted {
    border: 1px dotted #000; /* Replace #000 with the desired color for the border */
    background-color: transparent;
    color: #000; /* Replace #000 with the desired text color */
}

</style>
{% include 'components/alert.html' %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-12 col-12 mt-3">
            
            {% if purchase_order %}
                <div id="existingPurchaseOrderData" style="display: none;">
                    {{ existingPurchaseOrderData|json_script }}
                </div>
            {% endif %}
            <form method="post" {% if purchase_order %} action="{% url 'purchase_order_edit' purchase_order.id %}" {% else %}action="{% url 'purchase_order_add' %}"{% endif %} >
            
            {% csrf_token %}
            <div class="card">
              <div class="card-body px-4 pb-0">
                <div class="row">
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="po_number" class="form-label">Vendor <span class="text-danger">*</span></label>
                                <select class="form-control" id="vendor-choices" name="vendor_id">
                                    <option disabled selected value> Select an Vendor </option>

                                    {% for vendor in vendor_list %}
                                        <option value="{{vendor.id}}">{{vendor.email}}</option>
                                    {% endfor %}
                                </select>
                                <div id ="vendor-card" class="mt-3">
                                    <div class="card card-body border card-plain border-radius-lg align-items-center flex-row pt-3 px-3 pb-3 px-0 pb-0 pt-0 text-sm"  style="display: none;">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="inventory_location" class="form-label">Inventory Location <span class="text-danger">*</span></label>
                                <select class="form-control" id="inventory_location-choices" name="inventory_location_id">
                                    <option disabled selected value>Select Inventory Location</option>
                                    {% for inventory_location in inventory_location_list %}
                                        <option value="{{inventory_location.id}}">{{inventory_location.name}}</option>
                                    {% endfor %}
                                </select>
                                <div id ="inventorylocation-card" class="mt-3">
                                    <div class="card card-body border card-plain border-radius-lg align-items-center flex-row pt-3 px-3 pb-3 px-0 pb-0 pt-0 text-sm"  style="display: none;">
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="row mb-4">
                           <div class="col-md-12">
                                <label for="po_number" class="form-label">PO Number <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="po_number" value="8795646525451" name="po_number" >
                            </div>
                        </div>
                        
                    </div>
                </div>

                <div class="row mt-5">
                    <div class="col-md-12">
                        <table class="table-responsive custom-table mb-3  text-sm" style="width:100%">
                                <thead>
                                    <tr class="px-0">
                                        <th class="text-start col-6">Item Name</th>
                                        <th class="text-center col-2">Price(£)</th>
                                        <th class="text-center col-2">Quantity </th>
                                        <th class="text-center col-2">Total(£)</th>
                                        <th class="text-center col-2">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="itemTableBody">
                                    
                                </tbody>
                            </table>
                            <div class="error-message help-block mt-2 text-danger text-sm mb-2" id="rowError"></div>
                            <button class="btn btn-outline-dotted" id="addItemBtn" type="button">Add Item</button>
                        </div>
                    </div>
                
                <div class="row mt-4">
                    <div class="col-md-6 ">
                        {% if purchase_order.status == "sent_for_approval" %}
                        <p class="notes text-sm">{{ existingPurchaseOrderData.notes }}</p>
                        <label>Approval Notes</label>
                        <textarea class="form-control notes" rows="6" name="approval_notes" ></textarea>

                        {% elif purchase_order.status == "approved"  %}
                        <p class="notes text-sm">{{ existingPurchaseOrderData.notes }}</p>
                        Approval Notes
                        <p class="approval_notes text-sm">{{ existingPurchaseOrderData.approval_notes }}</p>
                        {% else %} 
                        <label>Notes</label>
                        <textarea class="form-control notes" rows="6" name="notes" ></textarea>
                        <div class="form-group mt-4 ">
                            <label>Attach File</label>
                            <input name="file" class="form-control" type="file" value="" autocomplete="off" accept="images/*, .pdf">
                            <small class="form-text text-muted">Only image formats are supported (jpg, jpeg, png, pdf).</small>  
                            {% if presigned_url %}
                            <br><br>
                            
                            <a href="{{presigned_url.0}}" class="text-sm">{{file_name}}</a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-1 "></div>
                    <div class="col-md-5">
                        <input type="hidden" id="subtotalInput" name="sub_total" value="0">
                        <input type="hidden" id="grandTotalInput" name="total_amount" value="0">
                        <div class="row mb-2">
                            <div class="col-6 text-end mb-1">
                                <p class="subtotal-label">Sub Total:</p>
                            </div>
                            <div class="col-6 mb-1">
                                <p class="mb-2 text-end subtotal-value"> £00.00</p>
                            </div>
                            <div class="col-6 mb-1 text-end">
                                <p class="discount-label">Discount:</p>
                            </div>
                            <div class="col-2 text-end mb-2"></div>
                            <div class="col-1 text-end mb-2"></div>
                            <div class="col-3 text-end mb-2">
                                <input type="number" class="form-control discount-input" id="discount" name="discount" min="0" placeholder="00.00" onchange="calculateTotal()" oninput="this.value = (parseInt(this.value) > 0 ? Math.abs(this.value) : 1)">
                            </div>
                            <div class="error-message  help-block mt-2 text-danger text-sm text-end mb-2" id="discountError"></div>
                           
                
                            <div class="col-6 mb-1 text-end">
                                <p class="tax-label">Tax (%):</p>
                            </div>
                            <div class="col-2 text-end mb-2"></div>
                            <div class="col-1 text-end mb-2"></div>
                            {% if tax_rate.tax_rate  %}
                            <div class="col-3 mb-1 tax-input text-end" id="tax">
                                {{tax_rate.tax_rate}}
                               
                            </div>
                            {% endif %}
                            <div class="col-6 mb-1 text-end">
                                <p class="font-weight-bolder mb-0 text-end grand-total-label">Grand Total:</p>
                            </div>
                            <div class="col-6 mb-1">
                                <p class="font-weight-bolder mb-0 text-end grand-total-value">£00.00</p>
                                <div class="error-message help-block mt-2 text-danger text-sm" id="grandTotalError"></div>

                            </div>
                        </div>
                    </div>
                 </div>
                <div class="row mt-5 mb-5">
                <div class="col-6 col-lg-6 m-auto text-end"></div>
                <div class="col-md-6 m-auto text-center text-md-end">
                    <a class="btn bg-gradient-secondary mb-0 js-btn-prev ms-2 mb-0" href="{% url 'purchase_order_list' %}">Cancel</a>
                    {% if purchase_order.status == "pending" or not purchase_order   %}
                    <button class="btn bg-gradient-primary mb-0 js-btn-prev  ms-2 mb-0" id="submitSaveAsDraftBtn" title="Submit">Save As Draft</button>
                    <button class="btn btn-md bg-gradient-primary ms-2 mb-0 js-btn-next" id="submitBtnApproval" title="Submit">Send For Approval</button>
                    {% elif purchase_order.status == "sent_for_approval" and request.user.roles.name == "projects_admin_(IT)"  %}
                    <button class="btn btn-md bg-gradient-primary ms-2 mb-0 js-btn-next" id="submitBtnApproved" title="Submit">I Approve this Purchase Order </button>
                    {% endif %}
                    
                </div>
                </div>
                
            </div>
        </div>
        {% include 'components/loader.html' %}
      </form>
 
</div>
</div>
</div>


{% endblock %}
{% block extra_js %}
<script src="{% static 'assets/js/plugins/choices.min.js' %}"></script>
<script src="{% static 'assets/js/plugins/flatpickr.min.js' %}"></script>
<script>
var item_list ;



// Get a reference to the input element
var invoiceInput = document.getElementById('po_number');

// Generate a unique number using the current timestamp
var uniqueNumber = Date.now();

// Set the generated unique number as the value of the input
invoiceInput.value = uniqueNumber;


const addItemBtn = document.getElementById('addItemBtn');

const subtotalValue = document.querySelector('.subtotal-value');
const discountInput = document.querySelector('.discount-input');
const taxInput = document.querySelector('.tax-input');
const grandTotalValue = document.querySelector('.grand-total-value');
const itemTableBody = document.getElementById('itemTableBody');

function getUnselectedOptions() {
    const selectedOptions = new Set();
    const allDropdowns = document.querySelectorAll('.item-dropdown');
    
    allDropdowns.forEach(dropdown => {
        const selectedOption = dropdown.options[dropdown.selectedIndex];
        selectedOptions.add(selectedOption.value);
    });

    let unselectedOptionsHtml = '';

    {% for item in item_list %}
        if (!selectedOptions.has('{{ item.id }}')) {
            unselectedOptionsHtml += `<option value="{{item.id}}" data-price="{{item.price}}">{{item.item_name}}</option>`;
        }
    {% endfor %}

    return unselectedOptionsHtml;
}

// Assume you have retrieved existingPurchaseOrderData from the backend
if (document.getElementById('existingPurchaseOrderData')) {
    const existingPurchaseOrderData = JSON.parse(document.getElementById('existingPurchaseOrderData').textContent);
    if (existingPurchaseOrderData) {
    // Function to safely access nested properties
    function safeGetProperty(obj, prop) {
        return obj && obj[prop] !== undefined ? obj[prop] : '';
    }
    // Populate the form fields with existing data
        document.getElementById('vendor-choices').value = safeGetProperty(existingPurchaseOrderData, 'vendor_id');
        document.getElementById('inventory_location-choices').value = safeGetProperty(existingPurchaseOrderData, 'inventory_location_id');
        document.getElementById('po_number').value = safeGetProperty(existingPurchaseOrderData, 'po_number');
       
        document.querySelector('.subtotal-value').textContent = `£${parseFloat(safeGetProperty(existingPurchaseOrderData, 'sub_total')).toFixed(2)}`;
        document.querySelector('.discount-input').value = parseFloat(safeGetProperty(existingPurchaseOrderData, 'discount')).toFixed(2);
        if ("{{ purchase_order.status }}" === "sent_for_approval") {
                const notesValue = "{{ existingPurchaseOrderData.notes }}";
                if (notesValue)
                {
                    document.querySelector('.notes').textContent = notesValue;
                }     
        }
        else
        {
            document.querySelector('.notes').value = safeGetProperty(existingPurchaseOrderData, 'notes');

        }
        document.querySelector('.grand-total-value').textContent = `£ ${parseFloat(safeGetProperty(existingPurchaseOrderData, 'grand_total')).toFixed(2)}`;
        // Populate item rows with existing item data

    
        // Populate vendor data for existing value on page load
    document.addEventListener('DOMContentLoaded', async function() {
        const existingVendorId = safeGetProperty(existingPurchaseOrderData, 'vendor_id');
        if (existingVendorId) {
            populateVendorData(existingVendorId);
        }
    });

    // Populate inventory location data for existing value on page load
    document.addEventListener('DOMContentLoaded', async function() {
        const existingInventoryLocationId = safeGetProperty(existingPurchaseOrderData, 'inventory_location_id');
        if (existingInventoryLocationId) {
            populateInventoryLocationData(existingInventoryLocationId);
        }
    });

    itemTableBody.innerHTML = ''; // Clear existing rows
    existingPurchaseOrderData.items.forEach(item => {
        
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
        <td>
            <select class="form-control item-dropdown" onchange="updatePrice(this)">
            ${getUnselectedOptions(item.item_id)}
            </select>
        </td>
        <td class="text-center item-price">${item.price}</td>
        <td class="text-center"><input type="number" class="form-control quantity-input" value="${item.quantity}" min="0" oninput="this.value = (parseInt(this.value) > 0 ? Math.abs(this.value) : 1)"></td>
        <td class="text-center total">${item.row_total}</td>
        <td class="text-center">
            <a class="remove-row-btn" onclick="removeRow(this)">
            <i class="fas fa-times"></i>
            </a>
        </td>
        `;
        itemTableBody.appendChild(newRow);
    });

    // Calculate and populate totals based on existing item data
    calculateTotal();

    // Preselect options in dropdowns based on existing data
    function preselectDropdownOption(dropdownId, value) {
        const dropdown = document.getElementById(dropdownId);
        if (dropdown) {
        const option = dropdown.querySelector(`option[value="${value}"]`);
        if (option) {
            option.selected = true;
        }
        }
    }
    preselectDropdownOption('vendor-choices', existingPurchaseOrderData.vendor_id);
    preselectDropdownOption('inventory_location-choices', existingPurchaseOrderData.inventory_location_id);
    }
}
    
let rowsAdded = 0; // Initialize a counter for added rows

addItemBtn.addEventListener('click', () => {
    const unselectedOptionsHtml = getUnselectedOptionsFromItemList(item_list);

    if (unselectedOptionsHtml === '') {
        const rowErrorElement = document.getElementById('rowError');
        if (rowErrorElement) {
            rowErrorElement.textContent = "All items have been selected. No more items left to add.";
            // Clear the error message after 1 second
            setTimeout(() => {
                rowErrorElement.textContent = "";
            }, 10000); // 1000 milliseconds = 1 second
        }
        return; // Exit the function to prevent adding new rows
    }

    if (rowsAdded >= item_list.length) {
        const rowErrorElement = document.getElementById('rowError');
        if (rowErrorElement) {
            rowErrorElement.textContent = "You can't add more rows. All items have been added.";
            // Clear the error message after 1 second
            hideLoader();
            setTimeout(() => {
                rowErrorElement.textContent = "";
            }, 10000); // 1000 milliseconds = 1 second
        }
        return; // Exit the function to prevent adding new rows
        
    }
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>
            <select id="itemSelect" class="form-select item-dropdown" onchange="updatePrice(this)">
                <option value="">Select Item</option>
                ${unselectedOptionsHtml}
            </select>
        </td>
        <td class="text-center item-price">00.00</td>
        <td class="text-center"><input type="number" class="form-control quantity-input" value="1" min="0" oninput="this.value = (parseInt(this.value) > 0 ? Math.abs(this.value) : 1)"></td>
        <td class="text-center total">00.00</td>
        <td class="text-center">
            <a class="remove-row-btn" onclick="removeRow(this)">
                <i class="fas fa-times"></i>
            </a>
        </td>
    `;

    itemTableBody.appendChild(newRow);
    setInitialPrice(newRow);
    
    rowsAdded++; // Increment the counter for added rows
});



// Initialize Choices.js
if (document.getElementById('vendor-choices')) {
  var element = document.getElementById('vendor-choices');
  const vendor_choices = new Choices(element, {
    default: false,
    items: [],
    choices: [],
    renderChoiceLimit: 1,
    searchEnabled: true,
    searchChoices: true,
    searchFloor: 1,
    searchResultLimit: 10,
    resetScrollPosition: true,
    shouldSort: true,
    shouldSortItems: false,
    searchFields: ['label'],
    searchPlaceholderValue: "Search Vendor", 
    fuseOptions: {
      includeScore: true,
      includeMatches: true,
      threshold: 0, // Set to 0 for exact match
      location: 0,
      distance: 100,
      maxPatternLength: 32,
      minMatchCharLength: 1
    }
  });
 }

// Function to populate vendor data in the card
async function populateVendorData(selectedVendorId) {
    try {
        const response = await fetch(`/purchase_order/get_vendor_data/?id=${selectedVendorId}`);
        const selectedVendorData = await response.json();

        const vendor_data = selectedVendorData.vendor_data
        item_list = selectedVendorData.item_list
        // Populate vevendor data in the card
        const cardBody = document.querySelector('#vendor-card .card-body');
        cardBody.style.display = 'block';  // Show the card body
        cardBody.innerHTML = `
        <h6 class="text-sm mb-1">${vendor_data.first_name} ${vendor_data.last_name}</h6>
        <p class="text-sm mb-1">${vendor_data.phone_number}</p>
        <p class="text-sm mb-1">${vendor_data.email}</p>
        `;
    } catch (error) {
        console.error('Error fetching vendor data:', error);
    }
}

// Listen for change event on the dropdown
element.addEventListener('change', async function(event) {
    const selectedVendorId = event.detail.value;
    populateVendorData(selectedVendorId);
    if (selectedVendorId) {
        // Enable the addItemBtn when a vendor is selected
        addItemBtn.disabled = false;
    } else {
        // Disable the addItemBtn when no vendor is selected
        addItemBtn.disabled = true;
    }
});
function getUnselectedOptionsFromItemList(itemList) {
    // Generate HTML options based on your itemList
    let unselectedOptionsHtml = '';

    for (const item of itemList) {
        unselectedOptionsHtml += `<option value="${item.id}" data-price="${item.price}">${item.item_name}</option>`;
    }

    return unselectedOptionsHtml;
}



itemTableBody.addEventListener('change', (event) => {
    if (event.target.classList.contains('item-price') || event.target.classList.contains('quantity-input')) {
        recalculateTotal(event.target.closest('tr'));
    }
    
   
});

            
function setInitialPrice(row) {
    const dropdown = row.querySelector('.item-dropdown');
    const selectedOption = dropdown.options[dropdown.selectedIndex];
    
    if (!selectedOption) {
        return; // No selected option, exit the function
    }
    
    const priceInput = row.querySelector('.item-price');
    priceInput.textContent = selectedOption.dataset.price;
    recalculateTotal(row);
}
let selectedValueToBeRemoved = null; // Variable to store the selected value to be removed

function updatePrice(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const row = selectElement.closest('tr');
    const priceInput = row.querySelector('.item-price');
    priceInput.textContent = selectedOption.dataset.price;

    const selectedValue = selectedOption.value;

    // Iterate through all rows
    const tableBody = document.getElementById('itemTableBody');
    const rows = tableBody.querySelectorAll('tr');

    rows.forEach(otherRow => {
        if (otherRow !== row) {
            const otherSelectElement = otherRow.querySelector('select');
            if (otherSelectElement) {
                // Remove the selected option from the other row's select element
                const optionToRemove = otherSelectElement.querySelector(`option[value="${selectedValue}"]`);
                if (optionToRemove) {
                    otherSelectElement.removeChild(optionToRemove);
                }
            }
        }
    });

    // Recalculate the total
    recalculateTotal(row);
}



function removeRow(buttonElement) {
    const row = buttonElement.closest('tr');
    row.remove();
    
}
function recalculateTotal(row) {
    const dropdown = row.querySelector('.item-dropdown');
    const selectedOption = dropdown.options[dropdown.selectedIndex];
    
    if (!selectedOption || selectedOption.value === '') {
        return; // No valid option selected, exit the function
    }

    const priceInput = row.querySelector('.item-price');
    const quantityInput = row.querySelector('.quantity-input');
    const totalCell = row.querySelector('.total');

    const price = parseFloat(priceInput.textContent);
    const quantity = parseFloat(quantityInput.value);

    if (!isNaN(price) && !isNaN(quantity) && price >= 0 && quantity >= 0) {
        const total = (price * quantity).toFixed(2);
        totalCell.textContent = total;
        calculateTotal();
    } 
    else {
        const rowErrorElement = row.querySelector('.rowError');
        if (rowErrorElement) {
            rowErrorElement.textContent = "Negative values are not allowed. Please enter a valid positive value.";
            hideLoader();
            // Clear the error message after 3 seconds
            setTimeout(() => {
                rowErrorElement.textContent = "";
            }, 3000); // 3000 milliseconds = 3 seconds
        }

        
        quantityInput.value = '';

        // Update the total cell to show the reset value
        totalCell.textContent = '00.00';
    }
}





function calculateTotal() {
    let subtotal = 0;
    const rows = itemTableBody.querySelectorAll('tr');
    
    rows.forEach(row => {
        const total = parseFloat(row.querySelector('.total').textContent);
        subtotal += total;
    });
    // Get discount and tax values (if they exist)
    const discountInput = document.getElementById('discount');
    const discount = parseFloat(discountInput.value) || 0; // Use 0 if parsing fails

    const taxInput = document.getElementById('tax');
    const tax = parseFloat(taxInput.textContent) || 0; // Use 0 if parsing fails

    // Clear previous error messages
    document.getElementById('discountError').textContent = '';
    document.getElementById('grandTotalError').textContent = '';
   
    
    
    if (subtotal > 0) 
    {
        
        if (isNaN(discount) || discount > subtotal) {
            document.getElementById('discountError').textContent = "Discount is invalid or greater than subtotal.";
            const discount = 0
            discountInput.value = 0.00
           
             // Calculate amounts
            const discountedSubtotal = subtotal - discount;
            const taxAmount = discountedSubtotal * (tax / 100); // Calculate tax as a percentage of discountedSubtotal
            const grandTotal = discountedSubtotal + taxAmount;
            // Update display values
            grandTotalValue.textContent = `£${grandTotal.toFixed(2)}`;
            subtotalValue.textContent = `£${subtotal.toFixed(2)}`;

            // Update hidden input values
            const subtotalInput = document.getElementById('subtotalInput');
            const grandTotalInput = document.getElementById('grandTotalInput');
            subtotalInput.value = subtotal.toFixed(2);
            grandTotalInput.value = grandTotal.toFixed(2);


            
        }
        else
        {
            // Calculate amounts
        const discountedSubtotal = subtotal - discount;
        const taxAmount = discountedSubtotal * (tax / 100); // Calculate tax as a percentage of discountedSubtotal
        const grandTotal = discountedSubtotal + taxAmount;
        

        // Update display values
        grandTotalValue.textContent = `£${grandTotal.toFixed(2)}`;
        subtotalValue.textContent = `£${subtotal.toFixed(2)}`;

        // Update hidden input values
        const subtotalInput = document.getElementById('subtotalInput');
        const grandTotalInput = document.getElementById('grandTotalInput');
        subtotalInput.value = subtotal.toFixed(2);
        grandTotalInput.value = grandTotal.toFixed(2);
        }
        
        
    }
    else
    {
        // Get discount and tax values (if they exist)
        const discountInput =document.getElementById('discount');
        const taxInput = document.getElementById('tax');
        const grandTotal= 0
        discountInput.value = 0.00
        
        
        // Update display values
        grandTotalValue.textContent =  0.00;
        subtotalValue.textContent =  0.00;

        // Update hidden input values
        const subtotalInput = document.getElementById('subtotalInput');
        const grandTotalInput = document.getElementById('grandTotalInput');
        subtotalInput.value = subtotal.toFixed(2);
        grandTotalInput.value = grandTotal.toFixed(2);
    }
    
    

}



    // Trigger the function on page load
window.addEventListener('load', function() {
const selectElement = document.getElementById('itemSelect');
updatePrice(selectElement);
});
 




if (document.getElementById('inventory_location-choices')) {
  var element = document.getElementById('inventory_location-choices');
  const inventory_location = new Choices(element, {
    default: false,
    items: [],
    choices: [],
    renderChoiceLimit: 1,
    maxItemCount: 1,
    searchEnabled: true,
    searchChoices: true,
    searchFloor: 1,
    searchResultLimit: 4,
    resetScrollPosition: true,
    shouldSort: true,
    shouldSortItems: false,
    searchFields: ['label'],
    searchPlaceholderValue: "Search Inventory Location",
    fuseOptions: {
      includeScore: true,
      includeMatches: true,
      threshold: 0, // Set to 0 for exact match
      location: 0,
      distance: 100,
      maxPatternLength: 32,
      minMatchCharLength: 1
    }
  });
}
// Function to populate inventory location data in the card
async function populateInventoryLocationData(selectedInventoryLocationId) {
    try {
        const response = await fetch(`/purchase_order/inventory_location/?id=${selectedInventoryLocationId}`);
        const selectedInventoryLocationData = await response.json();
        // Populate inventory location data in the card
        const cardBody = document.querySelector('#inventorylocation-card .card-body');
        cardBody.style.display = 'block';  // Show the card body
        cardBody.innerHTML = `
        <h6 class="text-sm mb-1">${selectedInventoryLocationData.data.name}</h6>
        <p class="text-sm mb-1">${selectedInventoryLocationData.data.full_address}</p>
        `;
    } catch (error) {
        console.error('Error fetching InventoryLocation data:', error);
    }
}

// Listen for change event on the dropdown
element.addEventListener('change', async function(event) {
    const selectedInventoryLocationId = event.detail.value;
    populateInventoryLocationData(selectedInventoryLocationId);
});

const loaderOverlay = document.getElementById("loaderOverlay"); // Loader overlay element

function showLoader() {
    loaderOverlay.classList.remove("d-none"); // Show the loader overlay
}

function hideLoader() {
    loaderOverlay.classList.add("d-none"); // Hide the loader overlay
}

// Inside your JavaScript
// Event listeners for the buttons
const submitSaveAsDraftBtn = document.getElementById('submitSaveAsDraftBtn');
const submitBtnApproval = document.getElementById('submitBtnApproval');
const submitBtnApproved = document.getElementById('submitBtnApproved');


if (submitSaveAsDraftBtn)
{
    submitSaveAsDraftBtn.addEventListener('click', function() {
    showLoader(); // Show the loader overlay before submitting
    submitForm('pending'); // Call the common function with the status

});

submitBtnApproval.addEventListener('click', function() {
    showLoader(); // Show the loader overlay before submitting
    submitForm('sent_for_approval'); // Call the common function with the status

});

}

submitBtnApproved.addEventListener('click', function() {
    showLoader(); // Show the loader overlay before submitting
    submitForm('approved'); // Call the common function with the status
});

function submitForm(status) {
    event.preventDefault(); // Prevent default button behavior

    const form = document.querySelector('form');
    
    const formData = new FormData(form);
    formData.append('status', status);
    
    // Get the subtotal, discount, and tax values
    const subtotal = parseFloat(subtotalValue.textContent);
     // Add the calculated values to the form data
    formData.append('subtotal', subtotal.toFixed(2));
    // Get and validate the discount value
    const discountInputValue = discountInput.value;
    const discount = parseFloat(discountInputValue);
    if (!isNaN(discount) && discountInputValue !== '') {
        formData.append('discount', discount.toFixed(2));
    } else {
        formData.append('discount', '0.00'); // Default to 0 if discount is empty or not a number
    }

    // Get and validate the tax value
    const taxInputValue = taxInput.textContent;
    const tax = parseFloat(taxInputValue);
    if (!isNaN(tax) && taxInputValue !== '') {
        formData.append('tax', tax.toFixed(2));
    } else {
        formData.append('tax', '0.00'); // Default to 0 if tax is empty or not a number
    }
    
   
    // Collect item row data
    const rows = itemTableBody.querySelectorAll('tr');
    let hasNonEmptyRow = false; // Flag to track non-empty rows

    rows.forEach(row => {
        const selectedOption = row.querySelector('.item-dropdown option:checked');
        const itemId = selectedOption.value;
        const itemPrice = parseFloat(row.querySelector('.item-price').textContent);
        const quantity = parseFloat(row.querySelector('.quantity-input').value);
        const rowTotal = parseFloat(row.querySelector('.total').textContent); // Get the row total
        
        // Check if any of the required fields are empty
        if (!itemId || isNaN(itemPrice) || isNaN(quantity) || isNaN(rowTotal) || quantity < 0) {
            
            hasNonEmptyRow = false

            const rowErrorElement = document.getElementById('rowError');
                if (rowErrorElement) {
                    rowErrorElement.textContent = "Please ensure all fields are filled correctly.";
                    hideLoader();
                    // Clear the error message after 1 second
                    setTimeout(() => {
                        rowErrorElement.textContent = "";
                    }, 10000); // 1000 milliseconds = 1 second
                }
            return; // Stop further processing
        }
        else
        {
            // Add item data to form data
            formData.append(`items[${itemId}][price]`, itemPrice.toFixed(2));
            formData.append(`items[${itemId}][quantity]`, quantity);
            formData.append(`items[${itemId}][rowTotal]`, rowTotal.toFixed(2)); // Append row total
            
            hasNonEmptyRow = true;
        }
        
        
    });

    if (!hasNonEmptyRow)
    {
        const rowErrorElement = document.getElementById('rowError');
        if (rowErrorElement) {
            rowErrorElement.textContent = "Please ensure all fields are filled correctly.";
            // Clear the error message after 1 second
            hideLoader();
            setTimeout(() => {
                    rowErrorElement.textContent = "";
                }, 10000); // 1000 milliseconds = 1 second
        }
    }

    
    if (hasNonEmptyRow) {
        // Make an AJAX POST request to your Django view
    fetch(form.action, {
        method: 'POST',
        body: formData,
    }).then(response => {
        response.json().then(data => {
            if (data.errors) {
                hideLoader();
                // Remove existing error messages
                const existingErrorMessages = document.querySelectorAll('.help-block');
                existingErrorMessages.forEach(errorMessage => errorMessage.remove());

                // Display validation errors under respective fields
                for (const fieldName in data.errors) {
                    const field = document.querySelector(`[name="${fieldName}"]`);
                    if (field) {
                        const tagName = field.nodeName.toLowerCase(); // Get the lowercase tag name
                        if (tagName === 'select') {
                            // For select elements, display error message near the select element
                            const selectContainer = field.closest('.choices'); // Adjust this selector based on your HTML structure
                            console.log(selectContainer)
                            if (selectContainer) {
                                const errorElement = document.createElement('div');
                                errorElement.classList.add('help-block', 'mt-2');
                                errorElement.textContent = data.errors[fieldName].join(', ');
                                selectContainer.appendChild(errorElement);
                            }
                        } else {
                            // For other input elements, display error message under the field
                            const errorElement = document.createElement('div');
                            errorElement.classList.add('help-block', 'mt-2');
                            errorElement.textContent = data.errors[fieldName].join(', ');
                            field.parentElement.appendChild(errorElement);
                        }
                    }
                }
            }
        else if  (response.ok)
        {
            // Successful response
            window.location.href = '/purchase_order/list/';
        }
        else {
            // Other error handling
            alert('An error occurred while saving items.');
        }



        });
        
        

    }).catch(error => {
        console.error('Error:', error);
    });
    }

    
}


</script>
{% endblock %}